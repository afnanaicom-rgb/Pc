<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary: #8b5cf6;
            --accent: #f59e0b;
            --bg-black: #000000;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.15);
            --wealth: #facc15;
            --magic: #d946ef;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: var(--bg-black);
            color: #fff; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±ÙˆÙ… Ø§Ù„ØµÙˆØªÙŠ */
        .room-container {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 10% 10%, #1e1b4b 0%, #000000 50%);
            z-index: 1000;
            display: none;
        }

        .room-container.active {
            display: block;
        }

        .mic-item {
            width: 62px; 
            height: 62px; 
            border-radius: 50%; 
            background: var(--glass);
            border: 1px solid var(--glass-border); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(5px); 
            transition: 0.3s;
            position: relative;
        }

        .mic-img { 
            width: 90%; 
            height: 90%; 
            border-radius: 50%; 
            object-fit: cover; 
            cursor: pointer;
        }

        .msg-bubble {
            background: rgba(255,255,255,0.08); 
            border: 1px solid var(--glass-border);
            padding: 10px; 
            border-radius: 18px; 
            border-bottom-right-radius: 2px;
            backdrop-filter: blur(10px); 
            display: flex; 
            align-items: flex-start; 
            gap: 10px;
            max-width: 85%; 
            animation: slideIn 0.3s ease;
        }

        .msg-avatar { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            border: 1px solid var(--accent); 
            cursor: pointer; 
            transition: 0.2s; 
        }

        .badge { 
            font-size: 8px; 
            padding: 1px 6px; 
            border-radius: 10px; 
            font-weight: bold; 
        }
        
        .b-wealth { 
            background: var(--wealth); 
            color: #000; 
        }
        
        .b-magic { 
            background: var(--magic); 
            color: #fff; 
        }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 2001;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin: 0 auto 16px;
        }

        /* Ø§Ù„Ø¨Ù†Ø± */
        .banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            opacity: 0.3;
            mix-blend-mode: overlay;
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tab-button {
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); 
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); 
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); 
            }
        }

        .room-pulse {
            animation: pulse 2s infinite;
        }

        .hidden { 
            display: none !important; 
        }

        .no-scrollbar::-webkit-scrollbar { 
            display: none; 
        }
        
        .no-scrollbar { 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
        .gift-effect {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 3000;
        }

        /* Ù…ÙŠÙƒØ§Øª Ø§Ù„Ø±ÙˆÙ… - 10 Ù…ÙŠÙƒØ§Øª */
        .mics-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .mics-container.bottom {
            margin-top: 20px;
        }

        .mics-divider {
            width: 100%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 10px 0;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="mainPage" class="min-h-screen pb-24">
        
        <!-- Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="banner h-48 mx-4 mt-4 mb-6 rounded-2xl flex items-center justify-center relative">
            <div class="relative z-10 text-center">
                <h1 class="text-3xl font-bold mb-2">ğŸ¤ Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø­ÙŠØ©</h1>
                <p class="text-gray-300">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</p>
            </div>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="flex justify-center gap-4 mb-6 px-4">
            <button id="tabPublic" class="tab-button active" onclick="switchTab('public')">
                <i class="fas fa-globe ml-2"></i> Ø¹Ø§Ù…
            </button>
            <button id="tabPrivate" class="tab-button" onclick="switchTab('private')">
                <i class="fas fa-lock ml-2"></i> Ø®Ø§Øµ
            </button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« -->
        <div class="px-4 mb-6">
            <div class="glass-card rounded-2xl p-3 flex items-center">
                <i class="fas fa-search text-gray-400 mx-2"></i>
                <input type="text" 
                       id="roomSearch" 
                       placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ©..." 
                       class="flex-1 bg-transparent border-0 focus:outline-none text-white">
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
        <div id="publicRoomsSection" class="px-4">
            <h2 class="text-xl font-bold mb-4">ğŸ”Š Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
            
            <div id="publicRoomsList" class="grid grid-cols-2 gap-3 mb-8">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø±ÙˆÙ…Ø§Øª -->
                <div class="text-center py-8 text-gray-500 col-span-2">
                    <i class="fas fa-comments text-3xl mb-3"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© -->
        <div id="privateRoomsSection" class="px-4 hidden">
            <!-- Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
            <div class="mb-6">
                <div class="glass-card rounded-2xl p-5 text-center cursor-pointer hover:bg-white/10 transition"
                     onclick="openCreateRoomModal()">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-plus text-white text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-1">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØªÙƒ Ø§Ù„Ø¢Ù†</h3>
                    <p class="text-sm text-gray-400">Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© ØµÙˆØªÙŠØ© Ø®Ø§ØµØ©</p>
                </div>
            </div>

            <h2 class="text-xl font-bold mb-4">ğŸ” ØºØ±ÙÙƒ Ø§Ù„Ø®Ø§ØµØ©</h2>
            
            <div id="privateRoomsList" class="space-y-3">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© -->
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users-slash text-3xl mb-3"></i>
                    <p>Ù„Ù… ØªÙ†Ø´Ø¦ Ø£ÙŠ ØºØ±Ù Ø®Ø§ØµØ© Ø¨Ø¹Ø¯</p>
                    <button onclick="openCreateRoomModal()" class="mt-4 px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition">
                        Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ ØºØ±ÙØ©
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ -->
        <nav class="glass fixed bottom-0 left-0 right-0 h-16 flex items-center justify-around border-t border-white/10 z-50">
            <button onclick="goToHome()" class="flex flex-col items-center text-blue-400">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </button>
            <button onclick="goToFriends()" class="flex flex-col items-center text-gray-400 hover:text-white">
                <i class="fas fa-user-friends text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span>
            </button>
            <button onclick="goToProfile()" class="flex flex-col items-center text-gray-400 hover:text-white">
                <i class="fas fa-user text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ù…Ù„Ù</span>
            </button>
            <button onclick="goToChat()" class="flex flex-col items-center text-gray-400 hover:text-white">
                <i class="fas fa-comment text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            </button>
        </nav>
    </div>

    <!-- Ø§Ù„Ø±ÙˆÙ… Ø§Ù„ØµÙˆØªÙŠ -->
    <div id="roomPage" class="room-container">
        <div class="app-container w-full h-full flex flex-col">
            <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±ÙˆÙ… -->
            <header class="header p-4 flex justify-between items-center border-b border-white/10">
                <button class="btn-control w-10 h-10 rounded-full glass flex items-center justify-center" onclick="minimizeRoom()">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div class="room-info glass rounded-3xl p-2 flex items-center gap-2 cursor-pointer" onclick="showRoomInfo()">
                    <img id="roomOwnerAvatar" src="" class="owner-img w-10 h-10 rounded-full border-2 border-accent">
                    <div>
                        <div class="text-sm font-bold" id="roomTitle">---</div>
                        <span class="text-xs text-accent" id="roomOnlineCount">0/10</span>
                    </div>
                </div>
                <button class="btn-control w-10 h-10 rounded-full bg-red-500 flex items-center justify-center" onclick="leaveRoom()">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </header>

            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ÙŠÙƒØ§Øª (10 Ù…ÙŠÙƒØ§Øª) -->
            <div class="mics-grid flex-1 p-4 overflow-y-auto">
                <div class="mics-container" id="topMicsGrid">
                    <!-- 5 Ù…ÙŠÙƒØ§Øª Ø¹Ù„ÙˆÙŠØ© -->
                </div>
                
                <div class="mics-divider"></div>
                
                <div class="mics-container bottom" id="bottomMicsGrid">
                    <!-- 5 Ù…ÙŠÙƒØ§Øª Ø³ÙÙ„ÙŠØ© -->
                </div>
            </div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª -->
            <div class="chat-area flex-1 overflow-y-auto p-4" id="chatArea">
                <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>

            <!-- Ø§Ù„ÙÙˆØªØ± -->
            <footer class="footer p-4 border-t border-white/10">
                <div class="flex items-center gap-2">
                    <button id="muteBtn" class="btn-action w-12 h-12 rounded-full glass flex items-center justify-center" onclick="toggleMute()">
                        <i class="fa-solid fa-microphone" id="muteIcon"></i>
                    </button>
                    
                    <div class="input-box flex-1 glass rounded-3xl p-2 flex items-center">
                        <input type="text" 
                               id="chatInput" 
                               class="main-input flex-1 bg-transparent border-0 focus:outline-none text-white" 
                               placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
                               onkeypress="if(event.key === 'Enter') sendMessage()">
                    </div>
                    
                    <button id="giftBtn" class="btn-action w-12 h-12 rounded-full glass flex items-center justify-center" onclick="openGiftSheet()">
                        <i class="fa-solid fa-gift text-accent"></i>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
    <div id="createRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© ØµÙˆØªÙŠØ©</h3>
                <button onclick="closeCreateRoomModal()" class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</label>
                    <input type="text" 
                           id="roomNameInput" 
                           placeholder="Ù…Ø«Ø§Ù„: Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡" 
                           class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm mb-2">ØµÙˆØ±Ø© Ø§Ù„ØºØ±ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" 
                           id="roomImageInput" 
                           placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" 
                           class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</p>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ©</label>
                    <select id="roomTypeInput" class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                        <option value="private">Ø®Ø§Øµ</option>
                        <option value="public">Ø¹Ø§Ù…</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</label>
                    <select id="maxUsersInput" class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                        <option value="10" selected>10 Ø£Ø´Ø®Ø§Øµ</option>
                        <option value="5">5 Ø£Ø´Ø®Ø§Øµ</option>
                        <option value="20">20 Ø´Ø®ØµØ§Ù‹</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="closeCreateRoomModal()" 
                            class="flex-1 py-3 rounded-2xl bg-white/10 hover:bg-white/20 transition">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button onclick="createRoom()" 
                            class="flex-1 py-3 rounded-2xl bg-gradient-to-r from-blue-500 to-purple-500 hover:opacity-90 transition">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ -->
    <div id="giftSheet" class="bottom-sheet">
        <div class="sheet-handle"></div>
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</h3>
            <button onclick="closeGiftSheet()" class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù… -->
        <div class="mb-6">
            <h4 class="text-sm font-bold mb-3">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…:</h4>
            <div id="userSelector" class="flex gap-3 overflow-x-auto pb-3">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            </div>
        </div>
        
        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡Ø¯ÙŠØ© -->
        <div class="mb-6">
            <h4 class="text-sm font-bold mb-3">Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯ÙŠØ©:</h4>
            <div id="giftsGrid" class="grid grid-cols-4 gap-3">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ù…Ù† Firebase -->
            </div>
        </div>
        
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-sm text-gray-400">Ø¥Ù„Ù‰:</div>
                    <div id="selectedRecipientName" class="font-bold">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Ø§Ù„Ù‡Ø¯ÙŠØ©:</div>
                    <div id="selectedGiftName" class="font-bold">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Ø§Ù„Ø³Ø¹Ø±:</div>
                    <div id="selectedGiftPrice" class="font-bold text-accent">0 ğŸ’°</div>
                </div>
            </div>
        </div>
        
        <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
        <button onclick="sendGift()" class="w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 hover:opacity-90 transition font-bold">
            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©
        </button>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="userProfileModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
                <button onclick="closeUserProfileModal()" class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="text-center mb-6">
                <img id="profileAvatar" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-accent mb-3">
                <h4 id="profileName" class="font-bold text-xl"></h4>
                <p id="profileId" class="text-gray-400 text-sm">ID: ---</p>
                <div class="flex justify-center gap-2 mt-2">
                    <span id="profileMagic" class="badge b-magic">âœ¨ 0</span>
                    <span id="profileWealth" class="badge b-wealth">ğŸ’° 0</span>
                </div>
            </div>
            
            <!-- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù -->
            <div id="adminActions" class="space-y-2 hidden">
                <button onclick="kickFromMic()" class="w-full py-3 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition">
                    <i class="fas fa-microphone-slash ml-2"></i> Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…ÙŠÙƒ
                </button>
                <button onclick="kickFromRoom()" class="w-full py-3 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition">
                    <i class="fas fa-sign-out-alt ml-2"></i> Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„Ø±ÙˆÙ…
                </button>
                <button onclick="banUser()" class="w-full py-3 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition">
                    <i class="fas fa-ban ml-2"></i> Ø­Ø¸Ø± Ù„Ù„Ø£Ø¨Ø¯
                </button>
            </div>
            
            <!-- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ -->
            <div id="userActions" class="space-y-2">
                <button onclick="sendPrivateMessage()" class="w-full py-3 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition">
                    <i class="fas fa-envelope ml-2"></i> Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©
                </button>
                <button onclick="followUser()" class="w-full py-3 rounded-xl bg-green-500/20 text-green-400 hover:bg-green-500/30 transition">
                    <i class="fas fa-user-plus ml-2"></i> Ù…ØªØ§Ø¨Ø¹Ø©
                </button>
            </div>
        </div>
    </div>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb",
            databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com/"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let currentUser = null;
        let currentUserData = null;
        let currentRoom = null;
        let roomData = null;
        let localStream = null;
        let peerConnections = {};
        let isMuted = false;
        let selectedGift = null;
        let selectedRecipient = null;
        let selectedUserId = null;
        let gifts = [];

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData();
                    await checkCurrentRoom();
                    await loadRooms();
                    await loadGifts(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    window.location.href = 'login.html';
                }
            });
        });

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ ØºØ±ÙØ© Ù†Ø´Ø·Ø©
                    if (currentUserData.currentRoom) {
                        currentRoom = currentUserData.currentRoom;
                        await joinExistingRoom(currentRoom);
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        async function checkCurrentRoom() {
            if (!currentUserData || !currentUserData.currentRoom) return;
            
            try {
                const roomDoc = await db.collection('rooms').doc(currentUserData.currentRoom).get();
                if (roomDoc.exists) {
                    currentRoom = currentUserData.currentRoom;
                    roomData = roomDoc.data();
                    await joinExistingRoom(currentRoom);
                } else {
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    await db.collection('users').doc(currentUser.uid).update({
                        currentRoom: null
                    });
                }
            } catch (error) {
                console.error('Error checking current room:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª
        async function loadRooms() {
            try {
                showLoading();
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                const publicRoomsSnap = await db.collection('rooms')
                    .where('type', '==', 'public')
                    .where('isActive', '==', true)
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                displayPublicRooms(publicRoomsSnap.docs);
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await loadPrivateRooms();
                
                hideLoading();
                
            } catch (error) {
                console.error('Error loading rooms:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª', 'error');
                
                const publicRoomsList = document.getElementById('publicRoomsList');
                publicRoomsList.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª</p>
                        <button onclick="loadRooms()" class="mt-4 px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition">
                            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>
                `;
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        function displayPublicRooms(rooms) {
            const publicRoomsList = document.getElementById('publicRoomsList');
            
            if (rooms.length === 0) {
                publicRoomsList.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500">
                        <i class="fas fa-comments text-3xl mb-3"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        <button onclick="openCreateRoomModal()" class="mt-4 px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition">
                            Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ Ø±ÙˆÙ…
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            rooms.forEach(roomDoc => {
                const room = roomDoc.data();
                const userCount = room.users ? room.users.length : 0;
                const isFull = userCount >= room.maxUsers;
                const isInRoom = room.users ? room.users.some(u => u.uid === currentUser?.uid) : false;
                
                html += `
                    <div class="glass-card rounded-2xl overflow-hidden cursor-pointer" onclick="previewRoom('${roomDoc.id}')">
                        <div class="h-32 relative">
                            <img src="${room.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                                 class="w-full h-full object-cover">
                            <div class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded-lg text-xs">
                                ${userCount}/${room.maxUsers}
                            </div>
                            ${isFull ? '<div class="absolute top-2 left-2 bg-red-500/80 px-2 py-1 rounded-lg text-xs">Ù…Ù…ØªÙ„Ø¦</div>' : ''}
                        </div>
                        <div class="p-3">
                            <h4 class="font-bold text-sm truncate">${room.name}</h4>
                            <div class="flex items-center gap-2 mt-2">
                                <img src="${room.ownerAvatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="w-6 h-6 rounded-full">
                                <span class="text-xs text-gray-400">${room.ownerName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                            </div>
                            ${isInRoom ? '<div class="mt-2 text-xs text-green-400"><i class="fas fa-check ml-1"></i>Ø£Ù†Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©</div>' : ''}
                        </div>
                    </div>
                `;
            });

            publicRoomsList.innerHTML = html;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
        async function loadPrivateRooms() {
            try {
                const privateRoomsList = document.getElementById('privateRoomsList');
                
                // Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const createdRoomsSnap = await db.collection('rooms')
                    .where('ownerId', '==', currentUser.uid)
                    .where('type', '==', 'private')
                    .where('isActive', '==', true)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (createdRoomsSnap.empty) {
                    privateRoomsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-users-slash text-3xl mb-3"></i>
                            <p>Ù„Ù… ØªÙ†Ø´Ø¦ Ø£ÙŠ ØºØ±Ù Ø®Ø§ØµØ© Ø¨Ø¹Ø¯</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                createdRoomsSnap.forEach(doc => {
                    const room = doc.data();
                    const userCount = room.users ? room.users.length : 0;
                    
                    html += `
                        <div class="glass-card rounded-2xl p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img src="${room.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                                     class="w-12 h-12 rounded-lg object-cover">
                                <div>
                                    <h4 class="font-bold">${room.name}</h4>
                                    <p class="text-xs text-gray-400">${userCount} Ø£Ø¹Ø¶Ø§Ø¡</p>
                                </div>
                            </div>
                            <button onclick="joinRoom('${doc.id}')" class="px-3 py-1 rounded-lg bg-blue-500 hover:bg-blue-600 transition text-sm">
                                Ø¯Ø®ÙˆÙ„
                            </button>
                        </div>
                    `;
                });

                privateRoomsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading private rooms:', error);
            }
        }

        // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙˆÙ…
        async function previewRoom(roomId) {
            try {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                
                if (!roomDoc.exists) {
                    showNotification('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                const room = roomDoc.data();
                const userCount = room.users ? room.users.length : 0;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©
                if (userCount >= room.maxUsers) {
                    showNotification('Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©', 'warning');
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØºØ±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹
                if (currentRoom) {
                    if (confirm('Ø£Ù†Øª ÙÙŠ ØºØ±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ÙˆØ§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                        await leaveCurrentRoom();
                        await joinRoom(roomId);
                    }
                } else {
                    await joinRoom(roomId);
                }
                
            } catch (error) {
                console.error('Error previewing room:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…
        async function joinRoom(roomId) {
            try {
                showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©...', 'info');
                
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                if (!roomDoc.exists) {
                    showNotification('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                const room = roomDoc.data();
                const userCount = room.users ? room.users.length : 0;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØºØ±ÙØ© Ø£Ø®Ø±Ù‰
                if (currentUserData && currentUserData.currentRoom && currentUserData.currentRoom !== roomId) {
                    if (!confirm('Ù„Ø¯ÙŠÙƒ ØºØ±ÙØ© Ù†Ø´Ø·Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±ØªÙ‡Ø§ ÙˆØ§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                        return;
                    }
                    await leaveCurrentRoom();
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
                const userExists = room.users ? room.users.some(u => u.uid === currentUser.uid) : false;
                
                if (!userExists) {
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØºØ±ÙØ©
                    const userData = {
                        uid: currentUser.uid,
                        name: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                        avatar: currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                        isMuted: false,
                        isSpeaker: true,
                        joinedAt: new Date(),
                        magicLevel: currentUserData?.magicLevel || 1,
                        wealthLevel: currentUserData?.wealthLevel || 1,
                        isOwner: room.ownerId === currentUser.uid
                    };

                    await db.collection('rooms').doc(roomId).update({
                        users: firebase.firestore.FieldValue.arrayUnion(userData)
                    });
                }

                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    currentRoom: roomId,
                    joinedRooms: firebase.firestore.FieldValue.arrayUnion(roomId)
                });

                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                currentRoom = roomId;
                roomData = room;
                
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                document.getElementById('mainPage').style.display = 'none';
                document.getElementById('roomPage').classList.add('active');
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±ÙˆÙ…
                updateRoomUI();
                
                // Ø¨Ø¯Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                await startWebRTCConnection();
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                setupRoomListeners();
                
                showNotification(`ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù€ ${room.name}`, 'success');
                
            } catch (error) {
                console.error('Error joining room:', error);
                showNotification(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø±ÙˆÙ… Ù…ÙˆØ¬ÙˆØ¯
        async function joinExistingRoom(roomId) {
            try {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                if (roomDoc.exists) {
                    roomData = roomDoc.data();
                    
                    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                    document.getElementById('mainPage').style.display = 'none';
                    document.getElementById('roomPage').classList.add('active');
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±ÙˆÙ…
                    updateRoomUI();
                    
                    // Ø¨Ø¯Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                    await startWebRTCConnection();
                    
                    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                    setupRoomListeners();
                }
            } catch (error) {
                console.error('Error joining existing room:', error);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        function setupRoomListeners() {
            if (!currentRoom) return;
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØºØ±ÙØ©
            db.collection('rooms').doc(currentRoom)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        roomData = doc.data();
                        updateRoomUI();
                    }
                });
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            db.collection('rooms').doc(currentRoom)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            displayMessage(message);
                        }
                    });
                });
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±ÙˆÙ…
        function updateRoomUI() {
            if (!roomData) return;
            
            document.getElementById('roomTitle').textContent = roomData.name;
            document.getElementById('roomOwnerAvatar').src = roomData.ownerAvatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            const userCount = roomData.users ? roomData.users.length : 0;
            document.getElementById('roomOnlineCount').textContent = `${userCount}/${roomData.maxUsers || 10}`;
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (10 Ù…ÙŠÙƒØ§Øª)
            updateMicsGrid();
        }

        // ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†Ø§Øª (10 Ù…ÙŠÙƒØ§Øª)
        function updateMicsGrid() {
            if (!roomData) return;
            
            const users = roomData.users || [];
            const topMicsGrid = document.getElementById('topMicsGrid');
            const bottomMicsGrid = document.getElementById('bottomMicsGrid');
            
            topMicsGrid.innerHTML = '';
            bottomMicsGrid.innerHTML = '';
            
            // 5 Ù…ÙŠÙƒØ§Øª Ø¹Ù„ÙˆÙŠØ©
            for (let i = 0; i < 5; i++) {
                const micItem = document.createElement('div');
                micItem.className = 'mic-item';
                
                if (i < users.length) {
                    const user = users[i];
                    micItem.innerHTML = `
                        <img src="${user.avatar}" 
                             class="mic-img" 
                             onclick="openUserProfile('${user.uid}')">
                        ${user.isMuted ? `
                        <div class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-microphone-slash text-xs"></i>
                        </div>` : ''}
                        ${user.isOwner ? `
                        <div class="absolute -bottom-1 -left-1 w-5 h-5 bg-yellow-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-crown text-xs"></i>
                        </div>` : ''}
                        <div class="absolute -bottom-4 right-0 left-0 text-center">
                            <span class="text-xs truncate max-w-full block px-1">${user.name}</span>
                        </div>
                    `;
                } else {
                    // Ù…ÙŠÙƒØ§Øª ÙØ§Ø±ØºØ©
                    micItem.innerHTML = `
                        <div class="mic-img bg-gray-800 flex items-center justify-center">
                            <i class="fas fa-plus text-gray-600"></i>
                        </div>
                        <div class="absolute -bottom-4 right-0 left-0 text-center">
                            <span class="text-xs text-gray-500">ÙØ§Ø±Øº</span>
                        </div>
                    `;
                }
                
                topMicsGrid.appendChild(micItem);
            }
            
            // 5 Ù…ÙŠÙƒØ§Øª Ø³ÙÙ„ÙŠØ©
            for (let i = 5; i < 10; i++) {
                const micItem = document.createElement('div');
                micItem.className = 'mic-item';
                
                if (i < users.length) {
                    const user = users[i];
                    micItem.innerHTML = `
                        <img src="${user.avatar}" 
                             class="mic-img" 
                             onclick="openUserProfile('${user.uid}')">
                        ${user.isMuted ? `
                        <div class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-microphone-slash text-xs"></i>
                        </div>` : ''}
                        ${user.isOwner ? `
                        <div class="absolute -bottom-1 -left-1 w-5 h-5 bg-yellow-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-crown text-xs"></i>
                        </div>` : ''}
                        <div class="absolute -bottom-4 right-0 left-0 text-center">
                            <span class="text-xs truncate max-w-full block px-1">${user.name}</span>
                        </div>
                    `;
                } else {
                    // Ù…ÙŠÙƒØ§Øª ÙØ§Ø±ØºØ©
                    micItem.innerHTML = `
                        <div class="mic-img bg-gray-800 flex items-center justify-center">
                            <i class="fas fa-plus text-gray-600"></i>
                        </div>
                        <div class="absolute -bottom-4 right-0 left-0 text-center">
                            <span class="text-xs text-gray-500">ÙØ§Ø±Øº</span>
                        </div>
                    `;
                }
                
                bottomMicsGrid.appendChild(micItem);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§ØªØµØ§Ù„ WebRTC
        async function startWebRTCConnection() {
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // ØªÙƒÙˆÙŠÙ† ICE servers
                const rtcConfig = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };

                showNotification('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'success');
                
            } catch (error) {
                console.error('Error starting WebRTC:', error);
                showNotification('ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'warning');
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
                displayMessage({
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                    senderAvatar: currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                    text: text,
                    timestamp: new Date(),
                    type: 'text'
                });
                
                // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await db.collection('rooms').doc(currentRoom)
                    .collection('messages')
                    .add({
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                        senderAvatar: currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                        text: text,
                        timestamp: new Date(),
                        type: 'text'
                    });
                
                input.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
        function displayMessage(message) {
            const chatArea = document.getElementById('chatArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'msg-bubble mb-3';
            
            if (message.type === 'system') {
                messageDiv.style.background = 'rgba(59, 130, 246, 0.2)';
            } else if (message.type === 'gift') {
                messageDiv.style.background = 'rgba(245, 158, 11, 0.2)';
            } else {
                messageDiv.style.background = 'rgba(139, 92, 246, 0.2)';
            }
            
            if (message.type === 'gift') {
                messageDiv.innerHTML = `
                    <img src="${message.giftData.senderAvatar}" class="msg-avatar">
                    <div class="msg-content">
                        <div class="msg-user text-sm font-bold">
                            ${message.giftData.senderName}
                        </div>
                        <div class="msg-text text-sm">
                            ğŸ Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ© ${message.giftData.giftIcon} Ù„Ù€ ${message.giftData.receiverName}
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <img src="${message.senderAvatar}" class="msg-avatar" onclick="openUserProfile('${message.senderId}')">
                    <div class="msg-content">
                        <div class="msg-user text-sm font-bold">
                            ${message.senderName}
                        </div>
                        <div class="msg-text text-sm">${message.text}</div>
                    </div>
                `;
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±ÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
        async function leaveCurrentRoom() {
            if (!currentRoom) return;
            
            try {
                // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØºØ±ÙØ©
                if (roomData && roomData.users) {
                    const updatedUsers = roomData.users.filter(u => u.uid !== currentUser.uid);
                    
                    if (updatedUsers.length === 0) {
                        // Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¥Ø°Ø§ Ø£ØµØ¨Ø­Øª ÙØ§Ø±ØºØ©
                        await db.collection('rooms').doc(currentRoom).delete();
                    } else {
                        await db.collection('rooms').doc(currentRoom).update({
                            users: updatedUsers
                        });
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    currentRoom: null
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                currentRoom = null;
                roomData = null;
                
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                document.getElementById('roomPage').classList.remove('active');
                document.getElementById('mainPage').style.display = 'block';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆÙ…Ø§Øª
                await loadRooms();
                
                showNotification('ØªÙ… Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©', 'success');
                
            } catch (error) {
                console.error('Error leaving room:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
        async function createRoom() {
            try {
                const roomName = document.getElementById('roomNameInput').value.trim();
                const roomImage = document.getElementById('roomImageInput').value.trim();
                const roomType = document.getElementById('roomTypeInput').value;
                const maxUsers = parseInt(document.getElementById('maxUsersInput').value);
                
                if (!roomName) {
                    showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„ØºØ±ÙØ©', 'warning');
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ØºØ±ÙØ© Ù†Ø´Ø·Ø©
                if (currentUserData && currentUserData.currentRoom) {
                    showNotification('Ù„Ø¯ÙŠÙƒ ØºØ±ÙØ© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ¬Ø¨ Ù…ØºØ§Ø¯Ø±ØªÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                    return;
                }

                showNotification('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©...', 'info');
                
                // Ø¥Ù†Ø´Ø§Ø¡ ID Ù„Ù„ØºØ±ÙØ©
                const roomId = generateRoomId();
                
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ©
                const roomData = {
                    id: roomId,
                    name: roomName,
                    image: roomImage || '',
                    type: roomType,
                    ownerId: currentUser.uid,
                    ownerName: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                    ownerAvatar: currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                    maxUsers: maxUsers,
                    users: [{
                        uid: currentUser.uid,
                        name: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                        avatar: currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                        isMuted: false,
                        isSpeaker: true,
                        joinedAt: new Date(),
                        magicLevel: currentUserData?.magicLevel || 1,
                        wealthLevel: currentUserData?.wealthLevel || 1,
                        isOwner: true
                    }],
                    createdAt: new Date(),
                    isActive: true
                };

                // Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ© ÙÙŠ Firestore
                await db.collection('rooms').doc(roomId).set(roomData);
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    currentRoom: roomId,
                    createdRooms: firebase.firestore.FieldValue.arrayUnion(roomId),
                    joinedRooms: firebase.firestore.FieldValue.arrayUnion(roomId)
                });

                closeCreateRoomModal();
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ù…Ø¨Ø§Ø´Ø±Ø©
                currentRoom = roomId;
                await joinRoom(roomId);
                
            } catch (error) {
                console.error('Error creating room:', error);
                showNotification(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù† Firebase
        async function loadGifts() {
            try {
                const giftsSnap = await db.collection('gifts').orderBy('price', 'asc').get();
                gifts = [];
                
                giftsSnap.forEach(doc => {
                    gifts.push({ id: doc.id, ...doc.data() });
                });
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù‡Ø¯Ø§ÙŠØ§ØŒ Ù†Ù†Ø´Ø¦ Ø¨Ø¹Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                if (gifts.length === 0) {
                    const defaultGifts = [
                        { id: '1', name: 'ÙˆØ±Ø¯Ø©', icon: 'ğŸŒ¹', price: 50 },
                        { id: '2', name: 'Ø£Ù„Ù…Ø§Ø³', icon: 'ğŸ’', price: 100 },
                        { id: '3', name: 'Ù‡Ø¯ÙŠØ©', icon: 'ğŸ', price: 200 },
                        { id: '4', name: 'ØªØ§Ø¬', icon: 'ğŸ‘‘', price: 500 },
                        { id: '5', name: 'Ù‚Ù„Ø¨', icon: 'â¤ï¸', price: 20 },
                        { id: '6', name: 'Ù†Ø¬Ù…Ø©', icon: 'â­', price: 80 },
                        { id: '7', name: 'ÙƒØ±Ø©', icon: 'âš½', price: 150 },
                        { id: '8', name: 'ÙƒØ£Ø³', icon: 'ğŸ†', price: 300 }
                    ];
                    
                    defaultGifts.forEach(async gift => {
                        await db.collection('gifts').doc(gift.id).set(gift);
                    });
                    
                    gifts = defaultGifts;
                }
                
            } catch (error) {
                console.error('Error loading gifts:', error);
            }
        }

        // ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
        async function openGiftSheet() {
            if (!currentRoom || !roomData) {
                showNotification('ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const userSelector = document.getElementById('userSelector');
            const giftsGrid = document.getElementById('giftsGrid');
            
            userSelector.innerHTML = '';
            giftsGrid.innerHTML = '';
            
            // Ø¹Ø±Ø¶ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø±ÙˆÙ…
            if (roomData.users) {
                roomData.users.forEach(user => {
                    if (user.uid === currentUser.uid) return;
                    
                    const userOption = document.createElement('div');
                    userOption.className = 'flex flex-col items-center cursor-pointer min-w-[70px]';
                    userOption.onclick = () => {
                        selectedRecipient = user;
                        document.querySelectorAll('#userSelector > div').forEach(el => {
                            el.classList.remove('border-accent');
                        });
                        userOption.classList.add('border-accent');
                        document.getElementById('selectedRecipientName').textContent = user.name;
                    };
                    
                    userOption.innerHTML = `
                        <img src="${user.avatar}" class="w-12 h-12 rounded-full border-2 border-transparent mb-1 object-cover">
                        <span class="text-xs truncate max-w-full">${user.name}</span>
                    `;
                    
                    userSelector.appendChild(userOption);
                });
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
            gifts.forEach(gift => {
                const giftCard = document.createElement('div');
                giftCard.className = 'glass-card rounded-xl p-3 text-center cursor-pointer';
                giftCard.onclick = () => {
                    selectedGift = gift;
                    document.querySelectorAll('#giftsGrid > div').forEach(el => {
                        el.classList.remove('border-2', 'border-accent');
                    });
                    giftCard.classList.add('border-2', 'border-accent');
                    document.getElementById('selectedGiftName').textContent = gift.name;
                    document.getElementById('selectedGiftPrice').textContent = `${gift.price} ğŸ’°`;
                };
                
                giftCard.innerHTML = `
                    <div class="text-2xl mb-1">${gift.icon}</div>
                    <div class="text-xs">${gift.price} ğŸ’°</div>
                `;
                
                giftsGrid.appendChild(giftCard);
            });
            
            document.getElementById('giftSheet').classList.add('active');
        }

        // Ø¥ØºÙ„Ø§Ù‚ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
        function closeGiftSheet() {
            document.getElementById('giftSheet').classList.remove('active');
            selectedGift = null;
            selectedRecipient = null;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©
        async function sendGift() {
            if (!selectedGift || !selectedRecipient) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯ÙŠØ© ÙˆÙ…Ø³ØªÙ„Ù…', 'warning');
                return;
            }

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
                const userBalance = currentUserData?.balance || 0;
                if (userBalance < selectedGift.price) {
                    showNotification('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ', 'warning');
                    return;
                }

                // Ø®ØµÙ… Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„
                await db.collection('users').doc(currentUser.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-selectedGift.price)
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯ÙŠØ© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                const giftData = {
                    giftId: selectedGift.id,
                    giftName: selectedGift.name,
                    giftIcon: selectedGift.icon,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                    senderAvatar: currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                    receiverId: selectedRecipient.uid,
                    receiverName: selectedRecipient.name,
                    price: selectedGift.price,
                    sentAt: new Date()
                };

                await db.collection('gifts_sent').add(giftData);
                
                // Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±Ø© Ø§Ù„Ø³Ø­Ø± Ù„Ù„Ù…Ø±Ø³Ù„
                await db.collection('users').doc(currentUser.uid).update({
                    magicExp: firebase.firestore.FieldValue.increment(selectedGift.price * 0.1),
                    magicLevel: Math.floor((currentUserData?.magicExp || 0 + selectedGift.price * 0.1) / 100) + 1
                });

                // Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±Ø© Ø§Ù„Ø«Ø±ÙˆØ© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                await db.collection('users').doc(selectedRecipient.uid).update({
                    wealthExp: firebase.firestore.FieldValue.increment(selectedGift.price * 0.05),
                    wealthLevel: Math.floor((currentUserData?.wealthExp || 0 + selectedGift.price * 0.05) / 100) + 1
                });

                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
                const messageData = {
                    type: 'gift',
                    giftData: giftData,
                    timestamp: new Date()
                };

                await db.collection('rooms').doc(currentRoom)
                    .collection('messages')
                    .add(messageData);

                // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ø¯ÙŠØ©
                showGiftEffect(selectedGift.icon);
                
                closeGiftSheet();
                showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await loadUserData();
                
            } catch (error) {
                console.error('Error sending gift:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©', 'error');
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ø¯ÙŠØ©
        function showGiftEffect(giftIcon) {
            const effect = document.createElement('div');
            effect.className = 'gift-effect';
            effect.innerHTML = `
                <div class="text-8xl animate-ping">${giftIcon}</div>
            `;
            
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1500);
        }

        // ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        async function openUserProfile(userId) {
            selectedUserId = userId;
            
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    document.getElementById('profileAvatar').src = userData.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                    document.getElementById('profileName').textContent = userData.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    document.getElementById('profileId').textContent = `ID: ${userId.substring(0, 8)}`;
                    document.getElementById('profileMagic').textContent = `âœ¨ ${userData.magicLevel || 1}`;
                    document.getElementById('profileWealth').textContent = `ğŸ’° ${userData.wealthLevel || 1}`;
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ù…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ© ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù†ÙØ³Ù‡ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
                    if (roomData.ownerId === currentUser.uid && userId !== currentUser.uid) {
                        document.getElementById('adminActions').classList.remove('hidden');
                        document.getElementById('userActions').classList.add('hidden');
                    } else {
                        document.getElementById('adminActions').classList.add('hidden');
                        document.getElementById('userActions').classList.remove('hidden');
                    }
                    
                    document.getElementById('userProfileModal').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'error');
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        function closeUserProfileModal() {
            document.getElementById('userProfileModal').classList.remove('active');
        }

        // Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…ÙŠÙƒ
        async function kickFromMic() {
            if (!selectedUserId || !currentRoom) return;
            
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØºØ±ÙØ©
                const roomDoc = await db.collection('rooms').doc(currentRoom).get();
                const roomData = roomDoc.data();
                const updatedUsers = roomData.users.map(user => {
                    if (user.uid === selectedUserId) {
                        return { ...user, isSpeaker: false };
                    }
                    return user;
                });
                
                await db.collection('rooms').doc(currentRoom).update({
                    users: updatedUsers
                });
                
                showNotification('ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…ÙŠÙƒ', 'success');
                closeUserProfileModal();
            } catch (error) {
                console.error('Error kicking from mic:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…ÙŠÙƒ', 'error');
            }
        }

        // Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„Ø±ÙˆÙ…
        async function kickFromRoom() {
            if (!selectedUserId || !currentRoom) return;
            
            try {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©
                const roomDoc = await db.collection('rooms').doc(currentRoom).get();
                const roomData = roomDoc.data();
                const updatedUsers = roomData.users.filter(user => user.uid !== selectedUserId);
                
                await db.collection('rooms').doc(currentRoom).update({
                    users: updatedUsers
                });
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…
                await db.collection('rooms').doc(currentRoom)
                    .collection('messages')
                    .add({
                        type: 'system',
                        text: `ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØºØ±ÙØ©`,
                        timestamp: new Date()
                    });
                
                showNotification('ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØºØ±ÙØ©', 'success');
                closeUserProfileModal();
            } catch (error) {
                console.error('Error kicking from room:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        async function banUser() {
            if (!selectedUserId || !currentRoom) return;
            
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©
                await db.collection('rooms').doc(currentRoom).update({
                    bannedUsers: firebase.firestore.FieldValue.arrayUnion(selectedUserId)
                });
                
                // Ø·Ø±Ø¯Ù‡ Ù…Ù† Ø§Ù„ØºØ±ÙØ©
                await kickFromRoom();
                
                showNotification('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø£Ø¨Ø¯ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©', 'success');
                closeUserProfileModal();
            } catch (error) {
                console.error('Error banning user:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        }

        // ØªØ¨Ø¯ÙŠÙ„ ÙƒØªÙ… Ø§Ù„ØµÙˆØª
        async function toggleMute() {
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    isMuted = false;
                } catch (error) {
                    showNotification('ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'warning');
                    return;
                }
            }
            
            isMuted = !isMuted;
            const audioTracks = localStream.getAudioTracks();
            
            audioTracks.forEach(track => {
                track.enabled = !isMuted;
            });
            
            const muteIcon = document.getElementById('muteIcon');
            const muteBtn = document.getElementById('muteBtn');
            
            if (isMuted) {
                muteIcon.className = 'fa-solid fa-microphone-slash';
                muteBtn.classList.add('bg-red-500');
                showNotification('ØªÙ… ÙƒØªÙ… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'warning');
            } else {
                muteIcon.className = 'fa-solid fa-microphone';
                muteBtn.classList.remove('bg-red-500');
                showNotification('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'success');
            }
        }

        // ØªØµØºÙŠØ± Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function minimizeRoom() {
            document.getElementById('roomPage').classList.remove('active');
            document.getElementById('mainPage').style.display = 'block';
            showNotification('ØªÙ… ØªØµØºÙŠØ± Ø§Ù„ØºØ±ÙØ©', 'info');
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        function switchTab(tab) {
            const publicTabBtn = document.getElementById('tabPublic');
            const privateTabBtn = document.getElementById('tabPrivate');
            const publicSection = document.getElementById('publicRoomsSection');
            const privateSection = document.getElementById('privateRoomsSection');
            
            if (tab === 'public') {
                publicTabBtn.classList.add('active');
                privateTabBtn.classList.remove('active');
                publicSection.classList.remove('hidden');
                privateSection.classList.add('hidden');
            } else {
                publicTabBtn.classList.remove('active');
                privateTabBtn.classList.add('active');
                publicSection.classList.add('hidden');
                privateSection.classList.remove('hidden');
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
                loadPrivateRooms();
            }
        }

        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
        function openCreateRoomModal() {
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('roomNameInput').value = '';
            document.getElementById('roomImageInput').value = '';
            document.getElementById('roomTypeInput').value = 'private';
            document.getElementById('maxUsersInput').value = '10';
            
            document.getElementById('createRoomModal').classList.add('active');
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
        function closeCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('active');
        }

        // ØªÙˆÙ„ÙŠØ¯ ID Ù„Ù„ØºØ±ÙØ©
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotification(message, type = 'info') {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 px-4 py-3 rounded-xl z-50 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            notification.style.animation = 'slideIn 0.3s ease';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showLoading() {
            let loader = document.getElementById('loadingOverlay');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'loadingOverlay';
                loader.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
                loader.innerHTML = `
                    <div class="glass-card p-6 rounded-2xl flex flex-col items-center">
                        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p class="text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                `;
                document.body.appendChild(loader);
            }
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function hideLoading() {
            const loader = document.getElementById('loadingOverlay');
            if (loader) {
                loader.remove();
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„
        function goToHome() {
            if (currentRoom) {
                minimizeRoom();
            }
        }

        function goToFriends() {
            window.location.href = 'chat.html';
        }

        function goToProfile() {
            window.location.href = 'me.html';
        }

        function goToChat() {
            window.location.href = 'chat.html';
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±ÙˆÙ…
        function showRoomInfo() {
            if (!roomData) return;
            
            const info = `
Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©: ${roomData.name}
Ø§Ù„Ù†ÙˆØ¹: ${roomData.type === 'public' ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ'}
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${roomData.users ? roomData.users.length : 0}/${roomData.maxUsers}
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(roomData.createdAt.seconds * 1000).toLocaleDateString('ar-SA')}
            `.trim();
            
            alert(info);
        }

        function leaveRoom() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                leaveCurrentRoom();
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        function sendPrivateMessage() {
            showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©', 'info');
        }

        function followUser() {
            showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'info');
        }

        // Ù…Ù†Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙØ§Ø¬Ø¦
        window.addEventListener('beforeunload', async (e) => {
            if (currentRoom) {
                e.preventDefault();
                e.returnValue = 'Ø£Ù†Øª ÙÙŠ ØºØ±ÙØ© ØµÙˆØªÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
            }
        });
    </script>
</body>
</html>
