<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans Arabic', sans-serif;
            touch-action: manipulation;
        }

        body {
            background: radial-gradient(circle at 0% 0%, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        .room-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .speaking {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
            border-color: #22c55e;
        }

        .muted {
            opacity: 0.6;
            filter: grayscale(50%);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page-section { display: none; }
        .page-section.active { display: block; }
    </style>
</head>
<body class="antialiased">
    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="main-app" class="min-h-screen pb-24">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <header class="glass fixed top-0 left-0 right-0 h-16 z-50 px-4 flex items-center justify-between">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØª ğŸ’¬
            </h1>
            <div class="flex items-center gap-3">
                <button onclick="switchPage('profile')" class="w-10 h-10 rounded-full glass flex items-center justify-center">
                    <i class="fas fa-user"></i>
                </button>
                <button onclick="refreshRooms()" class="w-10 h-10 rounded-full glass flex items-center justify-center">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <main class="pt-20 px-4">
            <!-- Ù‚Ø³Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ… Ø¬Ø¯ÙŠØ¯ -->
            <div class="mb-6">
                <div class="glass-card p-4 rounded-3xl">
                    <h3 class="font-bold text-lg mb-3">Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ… ØµÙˆØªÙŠ Ø¬Ø¯ÙŠØ¯</h3>
                    <div class="space-y-3">
                        <input type="text" id="roomNameInput" 
                               placeholder="Ø§Ø³Ù… Ø§Ù„Ø±ÙˆÙ… (Ù…Ø«Ø§Ù„: Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡)" 
                               class="w-full p-3 rounded-2xl bg-white/5 border border-white/10 focus:border-blue-500 focus:outline-none">
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</label>
                                <select id="maxUsersInput" class="w-full p-3 rounded-2xl bg-white/5 border border-white/10 focus:border-blue-500 focus:outline-none">
                                    <option value="5">5 Ø£Ø´Ø®Ø§Øµ</option>
                                    <option value="10" selected>10 Ø£Ø´Ø®Ø§Øµ</option>
                                    <option value="20">20 Ø´Ø®ØµØ§Ù‹</option>
                                    <option value="50">50 Ø´Ø®ØµØ§Ù‹</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø±ÙˆÙ…</label>
                                <select id="roomTypeInput" class="w-full p-3 rounded-2xl bg-white/5 border border-white/10 focus:border-blue-500 focus:outline-none">
                                    <option value="public">Ø¹Ø§Ù…</option>
                                    <option value="private">Ø®Ø§Øµ</option>
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="createNewRoom()" 
                                class="w-full py-3 rounded-2xl bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold hover:opacity-90 transition">
                            <i class="fas fa-plus ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ… Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-lg">ğŸ¤ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                    <span id="activeRoomsCount" class="text-sm text-gray-400">0 Ø±ÙˆÙ…</span>
                </div>
                
                <div id="roomsList" class="space-y-3">
                    <!-- Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø³ØªØ­Ù…Ù„ Ù‡Ù†Ø§ -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-comments text-3xl mb-3"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆÙ…Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ Ø´Ø§Ø±ÙƒØª Ø¨Ù‡Ø§ -->
            <div class="mb-6">
                <h3 class="font-bold text-lg mb-3">ğŸ† Ø±ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                <div id="myRoomsList" class="space-y-3">
                    <!-- Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³ØªØ­Ù…Ù„ Ù‡Ù†Ø§ -->
                </div>
            </div>

            <!-- Ø±ÙˆÙ… Ø­Ø§Ù„ÙŠ -->
            <div id="currentRoomSection" class="hidden">
                <div id="roomContainer" class="mb-6"></div>
            </div>
        </main>

        <!-- Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ -->
        <nav class="glass fixed bottom-0 left-0 right-0 h-16 flex items-center justify-around">
            <button onclick="switchPage('home')" class="tab-button active flex flex-col items-center">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </button>
            <button onclick="switchPage('rooms')" class="tab-button flex flex-col items-center">
                <i class="fas fa-users text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø±ÙˆÙ…Ø§Øª</span>
            </button>
            <button onclick="openCreateRoomModal()" class="w-14 h-14 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center -mt-6 shadow-lg">
                <i class="fas fa-plus text-white text-xl"></i>
            </button>
            <button onclick="switchPage('friends')" class="tab-button flex flex-col items-center">
                <i class="fas fa-user-friends text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span>
            </button>
            <button onclick="switchPage('chat')" class="tab-button flex flex-col items-center">
                <i class="fas fa-comment text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            </button>
        </nav>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ… -->
    <div id="createRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ… ØµÙˆØªÙŠ</h3>
                <button onclick="closeCreateRoomModal()" class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">Ø§Ø³Ù… Ø§Ù„Ø±ÙˆÙ…</label>
                    <input type="text" id="modalRoomName" 
                           placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø±ÙˆÙ…" 
                           class="w-full p-3 rounded-2xl bg-white/5 border border-white/10 focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm mb-2">ÙˆØµÙ Ø§Ù„Ø±ÙˆÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="modalRoomDesc" 
                              rows="2"
                              placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ø±ÙˆÙ…..." 
                              class="w-full p-3 rounded-2xl bg-white/5 border border-white/10 focus:border-blue-500 focus:outline-none resize-none"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm mb-2">Ø§Ù„Ø³Ø¹Ø©</label>
                        <select id="modalMaxUsers" class="w-full p-3 rounded-2xl bg-white/5 border border-white/10 focus:border-blue-500 focus:outline-none">
                            <option value="2">2 Ø£Ø´Ø®Ø§Øµ</option>
                            <option value="5">5 Ø£Ø´Ø®Ø§Øµ</option>
                            <option value="10" selected>10 Ø£Ø´Ø®Ø§Øµ</option>
                            <option value="20">20 Ø´Ø®ØµØ§Ù‹</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</label>
                        <select id="modalRoomPrivacy" class="w-full p-3 rounded-2xl bg-white/5 border border-white/10 focus:border-blue-500 focus:outline-none">
                            <option value="public">Ø¹Ø§Ù…</option>
                            <option value="private">Ø®Ø§Øµ</option>
                            <option value="friends">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙ‚Ø·</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="closeCreateRoomModal()" 
                            class="flex-1 py-3 rounded-2xl bg-white/10 hover:bg-white/20 transition">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button onclick="createRoomFromModal()" 
                            class="flex-1 py-3 rounded-2xl bg-gradient-to-r from-blue-500 to-purple-500 hover:opacity-90 transition">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ…
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ… -->
    <div id="joinRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…</h3>
                <button onclick="closeJoinRoomModal()" class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="roomPreview">
                <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙˆÙ… Ø³ØªØ­Ù…Ù„ Ù‡Ù†Ø§ -->
            </div>
            
            <div class="flex gap-3 pt-4">
                <button onclick="closeJoinRoomModal()" 
                        class="flex-1 py-3 rounded-2xl bg-white/10 hover:bg-white/20 transition">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button onclick="joinSelectedRoom()" 
                        class="flex-1 py-3 rounded-2xl bg-gradient-to-r from-green-500 to-blue-500 hover:opacity-90 transition">
                    Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                </button>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ (Ù…Ø®ÙÙŠØ©) -->
    <div id="profile-page" class="page-section">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
    </div>
    
    <div id="friends-page" class="page-section">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
    </div>
    
    <div id="chat-page" class="page-section">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    </div>

    <!-- Scripts -->
    <script src="firebase-config.js"></script>
    <script src="rooms-system.js"></script>
    
    <script>
        let currentUser = null;
        let currentUserData = null;
        let selectedRoomToJoin = null;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            currentUser = auth.currentUser;
            currentUserData = await getCurrentUser();
            
            if (!currentUserData) {
                window.location.href = 'login.html';
                return;
            }

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª
            await loadRooms();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø±ÙˆÙ… Ø­Ø§Ù„ÙŠØ§Ù‹
            if (currentUserData.currentRoom) {
                await joinExistingRoom(currentUserData.currentRoom);
            }

            // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(loadRooms, 30000);
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª
        async function loadRooms() {
            try {
                const rooms = await roomsSystem.getActiveRooms();
                displayRooms(rooms);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                document.getElementById('activeRoomsCount').textContent = `${rooms.length} Ø±ÙˆÙ…`;
                
                // ØªØ­Ù…ÙŠÙ„ Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (currentUserData && currentUserData.joinedRooms) {
                    loadUserRooms(currentUserData.joinedRooms);
                }
                
            } catch (error) {
                console.error('Error loading rooms:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª', 'error');
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆÙ…Ø§Øª
        function displayRooms(rooms) {
            const roomsList = document.getElementById('roomsList');
            
            if (rooms.length === 0) {
                roomsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-comments text-3xl mb-3"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆÙ…Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        <button onclick="openCreateRoomModal()" class="mt-4 px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition">
                            <i class="fas fa-plus ml-2"></i> Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ Ø±ÙˆÙ…
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            rooms.forEach(room => {
                const isFull = room.users.length >= room.maxUsers;
                const isInRoom = room.users.some(u => u.uid === currentUser?.uid);
                
                html += `
                    <div class="glass-card p-4 rounded-3xl ${isInRoom ? 'border-2 border-blue-500' : ''}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <img src="${room.ownerAvatar}" class="w-12 h-12 rounded-full border-2 border-${room.isPublic ? 'green' : 'purple'}-500">
                                <div>
                                    <h4 class="font-bold">${room.name}</h4>
                                    <p class="text-xs text-gray-400">Ø£Ù†Ø´Ø£Ù‡: ${room.ownerName}</p>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold ${isFull ? 'text-red-400' : 'text-green-400'}">
                                    ${room.users.length}/${room.maxUsers}
                                </div>
                                <div class="text-xs text-gray-400">${room.isPublic ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ'}</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex -space-x-2">
                                ${room.users.slice(0, 4).map(user => `
                                    <img src="${user.avatar}" class="w-8 h-8 rounded-full border-2 border-gray-800" title="${user.name}">
                                `).join('')}
                                ${room.users.length > 4 ? `
                                    <div class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-800 flex items-center justify-center text-xs">
                                        +${room.users.length - 4}
                                    </div>
                                ` : ''}
                            </div>
                            <span class="text-sm text-gray-400">
                                <i class="fas fa-clock ml-1"></i> ${formatTimeAgo(room.createdAt)}
                            </span>
                        </div>
                        
                        <div class="flex gap-2">
                            ${isInRoom ? `
                                <button onclick="openRoom('${room.id}')" class="flex-1 py-2 rounded-xl bg-blue-500 hover:bg-blue-600 transition">
                                    <i class="fas fa-door-open ml-2"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆÙ…
                                </button>
                            ` : `
                                <button onclick="previewRoom('${room.id}')" 
                                        class="flex-1 py-2 rounded-xl ${isFull ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'} transition"
                                        ${isFull ? 'disabled' : ''}>
                                    <i class="fas fa-sign-in-alt ml-2"></i> ${isFull ? 'Ù…Ù…ØªÙ„Ø¦' : 'Ø§Ù†Ø¶Ù…Ø§Ù…'}
                                </button>
                            `}
                            <button onclick="showRoomInfo('${room.id}')" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition">
                                <i class="fas fa-info"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            roomsList.innerHTML = html;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function loadUserRooms(roomIds) {
            const myRoomsList = document.getElementById('myRoomsList');
            
            if (!roomIds || roomIds.length === 0) {
                myRoomsList.innerHTML = `
                    <div class="text-center py-4 text-gray-500 text-sm">
                        Ù„Ù… ØªÙ†Ø¶Ù… Ù„Ø£ÙŠ Ø±ÙˆÙ… Ø¨Ø¹Ø¯
                    </div>
                `;
                return;
            }

            // Ø¹Ø±Ø¶ Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©
            myRoomsList.innerHTML = `
                <div class="text-center py-4 text-gray-500 text-sm">
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø±ÙˆÙ…Ø§ØªÙƒ...
                </div>
            `;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ… Ø¬Ø¯ÙŠØ¯
        async function createNewRoom() {
            try {
                const roomName = document.getElementById('roomNameInput').value.trim();
                const maxUsers = parseInt(document.getElementById('maxUsersInput').value);
                const roomType = document.getElementById('roomTypeInput').value;
                
                if (!roomName) {
                    showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ø±ÙˆÙ…', 'warning');
                    return;
                }

                showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ…...', 'info');
                
                const roomId = await roomsSystem.createRoom(
                    roomName, 
                    maxUsers, 
                    roomType === 'public'
                );

                showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯
                await loadRooms();
                
                // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('roomNameInput').value = '';
                
            } catch (error) {
                console.error('Error creating room:', error);
                showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ…', 'error');
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ… Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        async function createRoomFromModal() {
            try {
                const roomName = document.getElementById('modalRoomName').value.trim();
                const roomDesc = document.getElementById('modalRoomDesc').value.trim();
                const maxUsers = parseInt(document.getElementById('modalMaxUsers').value);
                const privacy = document.getElementById('modalRoomPrivacy').value;
                
                if (!roomName) {
                    showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ø±ÙˆÙ…', 'warning');
                    return;
                }

                showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ…...', 'info');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ… Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                const user = auth.currentUser;
                const userData = await getCurrentUser();
                
                const roomId = roomsSystem.generateRoomId();
                const roomData = {
                    id: roomId,
                    name: roomName,
                    description: roomDesc || 'Ø±ÙˆÙ… ØµÙˆØªÙŠ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„ØªÙˆØ§ØµÙ„',
                    ownerId: user.uid,
                    ownerName: userData.displayName,
                    ownerAvatar: userData.photoURL,
                    maxUsers: maxUsers,
                    isPublic: privacy === 'public',
                    privacy: privacy,
                    users: [{
                        uid: user.uid,
                        name: userData.displayName,
                        avatar: userData.photoURL,
                        isMuted: false,
                        isSpeaker: true,
                        joinedAt: new Date(),
                        magicLevel: userData.magicLevel || 1,
                        wealthLevel: userData.wealthLevel || 1,
                        isOwner: true
                    }],
                    createdAt: new Date(),
                    isActive: true,
                    currentSpeakers: 1,
                    tags: ['ØµÙˆØªÙŠ', 'Ø¯Ø±Ø¯Ø´Ø©']
                };

                await db.collection('rooms').doc(roomId).set(roomData);
                await rtdb.ref(`rooms/${roomId}/signals`).set({});
                
                await db.collection('users').doc(user.uid).update({
                    currentRoom: roomId,
                    createdRooms: firebase.firestore.FieldValue.arrayUnion(roomId),
                    joinedRooms: firebase.firestore.FieldValue.arrayUnion(roomId)
                });

                roomsSystem.currentRoom = roomId;
                closeCreateRoomModal();
                
                showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                await loadRooms();
                
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø±ÙˆÙ…
                await roomsSystem.joinRoom(roomId);
                
            } catch (error) {
                console.error('Error creating room:', error);
                showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ…', 'error');
            }
        }

        // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙˆÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
        async function previewRoom(roomId) {
            try {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                
                if (!roomDoc.exists) {
                    showToast('Ø§Ù„Ø±ÙˆÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    return;
                }

                const roomData = roomDoc.data();
                selectedRoomToJoin = roomId;

                const roomPreview = document.getElementById('roomPreview');
                roomPreview.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 p-3 rounded-2xl bg-white/5">
                            <img src="${roomData.ownerAvatar}" class="w-16 h-16 rounded-full border-2 border-yellow-500">
                            <div>
                                <h4 class="font-bold text-lg">${roomData.name}</h4>
                                <p class="text-sm text-gray-400">${roomData.description || 'Ø±ÙˆÙ… ØµÙˆØªÙŠ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©'}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3">
                            <div class="text-center p-3 rounded-2xl bg-white/5">
                                <div class="text-2xl font-bold">${roomData.users.length}</div>
                                <div class="text-xs text-gray-400">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                            </div>
                            <div class="text-center p-3 rounded-2xl bg-white/5">
                                <div class="text-2xl font-bold">${roomData.currentSpeakers}</div>
                                <div class="text-xs text-gray-400">Ù…ØªØ­Ø¯Ø«ÙŠÙ†</div>
                            </div>
                            <div class="text-center p-3 rounded-2xl bg-white/5">
                                <div class="text-2xl font-bold">${roomData.maxUsers}</div>
                                <div class="text-xs text-gray-400">Ø§Ù„Ø³Ø¹Ø©</div>
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-bold mb-2">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†:</h5>
                            <div class="flex flex-wrap gap-2">
                                ${roomData.users.slice(0, 8).map(user => `
                                    <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-white/5">
                                        <img src="${user.avatar}" class="w-6 h-6 rounded-full">
                                        <span class="text-sm">${user.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                openJoinRoomModal();
                
            } catch (error) {
                console.error('Error previewing room:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙˆÙ…', 'error');
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯
        async function joinSelectedRoom() {
            if (!selectedRoomToJoin) return;
            
            try {
                closeJoinRoomModal();
                showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…...', 'info');
                
                await roomsSystem.joinRoom(selectedRoomToJoin);
                showToast('ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                document.getElementById('currentRoomSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error joining room:', error);
                showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…', 'error');
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø±ÙˆÙ… Ù…ÙˆØ¬ÙˆØ¯ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
        async function joinExistingRoom(roomId) {
            try {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                
                if (roomDoc.exists) {
                    await roomsSystem.joinRoom(roomId);
                    document.getElementById('currentRoomSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error joining existing room:', error);
                // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…ØŒ Ù†Ø²ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ… Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    currentRoom: null
                });
            }
        }

        // ÙØªØ­ Ø§Ù„Ø±ÙˆÙ…
        function openRoom(roomId) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø±ÙˆÙ…
            window.location.href = `room.html?id=${roomId}`;
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±ÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
        async function leaveCurrentRoom() {
            if (!roomsSystem.currentRoom) return;
            
            try {
                showToast('Ø¬Ø§Ø±ÙŠ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±ÙˆÙ…...', 'info');
                await roomsSystem.leaveRoom(roomsSystem.currentRoom);
                
                document.getElementById('currentRoomSection').classList.add('hidden');
                showToast('ØªÙ… Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±ÙˆÙ…', 'success');
                
                await loadRooms();
                
            } catch (error) {
                console.error('Error leaving room:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±ÙˆÙ…', 'error');
            }
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
        async function toggleMute() {
            await roomsSystem.toggleMute();
        }

        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ…
        function openCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('active');
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ…
        function closeCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('active');
        }

        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…
        function openJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.add('active');
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…
        function closeJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.remove('active');
            selectedRoomToJoin = null;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ÙˆÙ…
        async function showRoomInfo(roomId) {
            const roomDoc = await db.collection('rooms').doc(roomId).get();
            if (roomDoc.exists) {
                const roomData = roomDoc.data();
                
                const info = `
Ø§Ø³Ù… Ø§Ù„Ø±ÙˆÙ…: ${roomData.name}
Ø§Ù„Ù…Ø§Ù„Ùƒ: ${roomData.ownerName}
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${roomData.users.length}/${roomData.maxUsers}
Ø§Ù„Ù†ÙˆØ¹: ${roomData.isPublic ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ'}
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(roomData.createdAt.toDate()).toLocaleDateString('ar-SA')}
                `;
                
                alert(info);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆÙ…Ø§Øª
        function refreshRooms() {
            loadRooms();
            showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆÙ…Ø§Øª...', 'info');
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
        function switchPage(page) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            document.getElementById('main-app').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            document.getElementById(`${page}-page`).classList.add('active');
            document.getElementById(`${page}-page`).style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„ÙƒÙ„ ØµÙØ­Ø©
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function goHome() {
            document.getElementById('main-app').style.display = 'block';
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
        function formatTimeAgo(timestamp) {
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
            if (diffMins < 60) return `Ù‚Ø¨Ù„ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diffMins < 1440) return `Ù‚Ø¨Ù„ ${Math.floor(diffMins / 60)} Ø³Ø§Ø¹Ø©`;
            return `Ù‚Ø¨Ù„ ${Math.floor(diffMins / 1440)} ÙŠÙˆÙ…`;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showToast(message, type = 'info') {
            // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Toast Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ·
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 px-4 py-3 rounded-xl z-50 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Ù…Ù†Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙØ§Ø¬Ø¦ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø±ÙˆÙ…
        window.addEventListener('beforeunload', async (e) => {
            if (roomsSystem.currentRoom) {
                e.preventDefault();
                e.returnValue = 'Ø£Ù†Øª ÙÙŠ Ø±ÙˆÙ… ØµÙˆØªÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±ÙˆÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
                await roomsSystem.leaveRoom(roomsSystem.currentRoom);
            }
        });

        // Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
        navigator.mediaDevices.addEventListener('devicechange', () => {
            console.log('ØªØºÙŠØ±Øª Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØµÙˆØª');
        });
    </script>
</body>
</html>
