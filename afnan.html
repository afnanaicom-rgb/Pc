<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - الرئيسية</title>
    
    <!-- Fonts: Noto Sans Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans Arabic', sans-serif;
            touch-action: manipulation;
        }

        body {
            background: radial-gradient(circle at 0% 0%, #eef2ff 0%, #fdf2f8 50%, #f0f9ff 100%);
            color: #1f2937;
            overflow-x: hidden;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        body.dark-mode {
            background: radial-gradient(circle at 0% 0%, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f1f5f9;
        }

        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .dark-mode .glass {
            background: rgba(30, 41, 59, 0.75);
            border: 1px solid rgba(51, 65, 85, 0.6);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-mode .glass-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(51, 65, 85, 0.4);
            color: #f1f5f9;
        }

        .glass-card:active {
            transform: scale(0.97);
        }

        .bottom-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            z-index: 50;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.6);
        }

        .dark-mode .bottom-tab-bar {
            background: rgba(30, 41, 59, 0.85);
            border-top: 1px solid rgba(51, 65, 85, 0.6);
        }

        .tab-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            color: #666;
        }

        .dark-mode .tab-button {
            color: #94a3b8;
        }

        .tab-button.active {
            color: #000;
        }

        .dark-mode .tab-button.active {
            color: #f1f5f9;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            background-color: #000;
            border-radius: 50%;
        }

        .dark-mode .tab-button.active::after {
            background-color: #f1f5f9;
        }

        .tab-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .tab-label {
            font-size: 12px;
            font-weight: 600;
        }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased selection:bg-blue-100 selection:text-blue-900">
    <!-- MAIN APP -->
    <div id="main-app" class="min-h-screen pb-20">
        
        <!-- HEADER -->
        <header id="main-header" class="fixed top-0 left-0 right-0 h-20 z-30 px-6 flex items-center justify-between glass">
            <h2 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 dark:from-gray-100 dark:to-gray-400" id="header-title">الرئيسية</h2>
            <div class="flex items-center gap-3" id="header-buttons">
                <!-- Content will be filled by JavaScript -->
            </div>
        </header>

        <!-- PAGE CONTENT -->
        <main class="pt-24 px-5 pb-24">
            <!-- HOME PAGE -->
            <section id="page-home" class="active">
                <!-- HOME BANNER -->
                <div id="homeBanner" class="w-full h-32 rounded-[32px] glass-card mb-6 relative overflow-hidden flex items-center justify-center shadow-sm group"></div>
                
                <!-- SEARCH SECTION -->
                <div class="mb-8">
                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-200">بحث سريع</h3>
                    <div class="relative">
                        <input type="text" id="quickSearchInput" placeholder="ابحث عن مستخدم..." 
                               class="w-full p-4 pr-12 rounded-2xl glass-card border-0 focus:ring-0 focus:outline-none text-sm dark:bg-gray-800 dark:text-white">
                        <button onclick="quickSearch()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- FRIENDS PAGE CONTENT -->
                <div id="friends-section" class="hidden">
                    <div class="relative mb-6">
                        <input type="text" id="searchUserInput" placeholder="ابحث عن مستخدم بواسطة الـ ID..." 
                               class="w-full p-4 pr-12 rounded-2xl glass-card border-0 focus:ring-0 focus:outline-none text-sm dark:bg-gray-800 dark:text-white">
                        <button onclick="searchUser()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="space-y-3 mb-8 hidden">
                        <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">نتائج البحث</h3>
                        <div id="userResult" class="glass-card p-4 rounded-3xl"></div>
                    </div>
                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-200">طلبات المتابعة</h3>
                    <div id="friendRequestsList" class="space-y-3 mb-6"></div>
                    <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-200">أصدقائي</h3>
                    <div id="friendsList" class="space-y-3"></div>
                </div>
            </section>
        </main>

        <!-- BOTTOM TAB BAR -->
        <nav id="bottomTabBar" class="bottom-tab-bar flex items-center justify-between px-4">
            <button onclick="switchPage('home')" class="tab-button active">
                <i data-lucide="home" class="tab-icon"></i>
                <span class="tab-label">الرئيسية</span>
            </button>
            <button onclick="switchPage('friends')" class="tab-button">
                <i data-lucide="users" class="tab-icon"></i>
                <span class="tab-label">الأصدقاء</span>
            </button>
            <button onclick="goToProfile()" class="tab-button">
                <i data-lucide="user" class="tab-icon"></i>
                <span class="tab-label">الملف</span>
            </button>
        </nav>
    </div>

    <!-- FIREBASE AND APP SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, 
            collection, getDocs, increment, query, where, arrayUnion, 
            arrayRemove, orderBy
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb",
            databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userData = {};
        let storeData = { frames: [], badges: [], entrances: [], gifts: [], magicLevels: {}, wealthLevels: {} };
        let currentPage = 'home';

        // Check dark mode
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) document.body.classList.add('dark-mode');

        // Initialize app
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                onSnapshot(doc(db, "users", user.uid), async (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        await loadFriendRequests();
                        await loadFriends();
                    } else {
                        await createUserDoc(user);
                    }
                });
                await loadGlobalData();
                await loadBanner();
                updateHeader();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Navigation
        window.switchPage = (page) => {
            currentPage = page;
            const friendsSection = document.getElementById('friends-section');
            const headerTitle = document.getElementById('header-title');
            const headerButtons = document.getElementById('header-buttons');
            
            // Update active tab
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            if (page === 'home') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                friendsSection.classList.add('hidden');
                headerTitle.textContent = 'الرئيسية';
                headerButtons.innerHTML = `
                    <button onclick="openNotifications()" class="w-10 h-10 rounded-full flex items-center justify-center active:scale-90 transition">
                        <i data-lucide="bell" class="text-black dark:text-white w-5 h-5"></i>
                    </button>
                `;
            } else if (page === 'friends') {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                friendsSection.classList.remove('hidden');
                headerTitle.textContent = 'الأصدقاء';
                headerButtons.innerHTML = '';
            }
            
            lucide.createIcons();
        };

        window.goToProfile = () => {
            window.location.href = 'me.html';
        };

        function updateHeader() {
            // Already updated in switchPage
            lucide.createIcons();
        }

        // User Management
        async function createUserDoc(user) {
            await setDoc(doc(db, "users", user.uid), {
                displayName: user.displayName || "مستخدم جديد",
                photoURL: user.photoURL || "https://via.placeholder.com/150",
                email: user.email,
                uid: user.uid,
                balance: 1000,
                diamonds: 0,
                magicLevel: 1,
                wealthLevel: 1,
                magicExp: 0,
                wealthExp: 0,
                customId: Math.floor(100000 + Math.random() * 900000).toString(),
                purchasedFrames: [],
                purchasedBadges: [],
                purchasedEntrances: [],
                activeFrame: null,
                activeBadges: [],
                activeEntrance: null,
                friends: [],
                friendRequests: [],
                sentRequests: [],
                blockedUsers: [],
                receivedGifts: [],
                dailyGiftClaimed: false,
                createdAt: new Date()
            });
        }

        async function loadGlobalData() {
            try {
                const fSnap = await getDocs(collection(db, "frames"));
                storeData.frames = fSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const bSnap = await getDocs(collection(db, "badges"));
                storeData.badges = bSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const eSnap = await getDocs(collection(db, "entrances"));
                storeData.entrances = eSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const gSnap = await getDocs(collection(db, "gifts"));
                storeData.gifts = gSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const mlSnap = await getDocs(collection(db, "magicLevels"));
                mlSnap.docs.forEach(d => storeData.magicLevels[d.id] = d.data());
                
                const wlSnap = await getDocs(collection(db, "wealthLevels"));
                wlSnap.docs.forEach(d => storeData.wealthLevels[d.id] = d.data());
            } catch (error) {
                console.error("Error loading global data:", error);
            }
        }

        // Friends System
        window.searchUser = async () => {
            const id = document.getElementById('searchUserInput').value.trim();
            if (!id) return;
            const q = query(collection(db, "users"), where("customId", "==", id));
            const snap = await getDocs(q);
            const results = document.getElementById('searchResults');
            const container = document.getElementById('userResult');
            results.classList.remove('hidden');
            if (snap.empty) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm">لم يتم العثور على مستخدم</p>';
            } else {
                const user = snap.docs[0].data();
                const isFollowing = userData.friends?.includes(user.uid);
                const hasSentRequest = userData.sentRequests?.includes(user.uid);
                const hasReceivedRequest = userData.friendRequests?.includes(user.uid);
                const isBlocked = userData.blockedUsers?.includes(user.uid);
                
                let buttonText = 'متابعة';
                let buttonClass = 'bg-black text-white';
                let buttonAction = `sendFriendRequest('${user.uid}')`;
                
                if (isBlocked) {
                    buttonText = 'محظور';
                    buttonClass = 'bg-red-100 text-red-600';
                    buttonAction = `unblockUser('${user.uid}')`;
                } else if (isFollowing) {
                    buttonText = 'متابع';
                    buttonClass = 'bg-gray-100 text-gray-500';
                    buttonAction = `unfollowUser('${user.uid}')`;
                } else if (hasSentRequest) {
                    buttonText = 'تم الإرسال';
                    buttonClass = 'bg-blue-100 text-blue-600';
                    buttonAction = `cancelFriendRequest('${user.uid}')`;
                } else if (hasReceivedRequest) {
                    buttonText = 'قبول الطلب';
                    buttonClass = 'bg-green-100 text-green-600';
                    buttonAction = `acceptFriendRequest('${user.uid}')`;
                }
                
                container.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="${user.photoURL}" class="w-12 h-12 rounded-full object-cover">
                            <div>
                                <h4 class="font-bold text-sm dark:text-white">${user.displayName}</h4>
                                <p class="text-xs text-gray-400">ID: ${user.customId}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="${buttonAction}" class="px-4 py-2 rounded-xl ${buttonClass} font-bold text-xs">
                                ${buttonText}
                            </button>
                            ${!isFollowing && !hasReceivedRequest ? `
                            <button onclick="blockUser('${user.uid}')" class="px-3 py-2 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-bold text-xs">
                                <i data-lucide="slash" class="w-3 h-3"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>`;
            }
            lucide.createIcons();
        };

        window.quickSearch = async () => {
            const term = document.getElementById('quickSearchInput').value.trim();
            if (!term) return;
            switchPage('friends');
            document.getElementById('searchUserInput').value = term;
            await searchUser();
        };

        window.sendFriendRequest = async (uid) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                sentRequests: arrayUnion(uid)
            });
            
            await updateDoc(doc(db, "users", uid), {
                friendRequests: arrayUnion(auth.currentUser.uid)
            });
            
            searchUser();
            loadFriendRequests();
        };

        window.cancelFriendRequest = async (uid) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                sentRequests: arrayRemove(uid)
            });
            
            await updateDoc(doc(db, "users", uid), {
                friendRequests: arrayRemove(auth.currentUser.uid)
            });
            
            searchUser();
            loadFriendRequests();
        };

        window.acceptFriendRequest = async (uid) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                friendRequests: arrayRemove(uid),
                friends: arrayUnion(uid)
            });
            
            await updateDoc(doc(db, "users", uid), {
                sentRequests: arrayRemove(auth.currentUser.uid),
                friends: arrayUnion(auth.currentUser.uid)
            });
            
            searchUser();
            loadFriendRequests();
            loadFriends();
        };

        window.unfollowUser = async (uid) => {
            if (confirm('هل تريد إلغاء المتابعة؟')) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), {
                    friends: arrayRemove(uid)
                });
                
                await updateDoc(doc(db, "users", uid), {
                    friends: arrayRemove(auth.currentUser.uid)
                });
                
                searchUser();
                loadFriends();
            }
        };

        window.blockUser = async (uid) => {
            if (confirm('هل تريد حظر هذا المستخدم؟')) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), {
                    friends: arrayRemove(uid),
                    sentRequests: arrayRemove(uid),
                    friendRequests: arrayRemove(uid),
                    blockedUsers: arrayUnion(uid)
                });
                
                await updateDoc(doc(db, "users", uid), {
                    friends: arrayRemove(auth.currentUser.uid),
                    sentRequests: arrayRemove(auth.currentUser.uid),
                    friendRequests: arrayRemove(auth.currentUser.uid)
                });
                
                alert('تم حظر المستخدم');
                searchUser();
                loadFriendRequests();
                loadFriends();
            }
        };

        window.unblockUser = async (uid) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                blockedUsers: arrayRemove(uid)
            });
            
            alert('تم إلغاء حظر المستخدم');
            searchUser();
        };

        async function loadFriendRequests() {
            const list = document.getElementById('friendRequestsList');
            if (!list) return;
            list.innerHTML = '';
            if (!userData.friendRequests || userData.friendRequests.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 dark:text-gray-500 text-sm py-4">لا توجد طلبات متابعة</p>';
                return;
            }
            
            for (const uid of userData.friendRequests) {
                const snap = await getDoc(doc(db, "users", uid));
                if (snap.exists()) {
                    const user = snap.data();
                    list.innerHTML += `
                        <div class="glass-card p-4 rounded-3xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <img src="${user.photoURL}" class="w-12 h-12 rounded-full object-cover">
                                    <div>
                                        <h4 class="font-bold text-sm dark:text-white">${user.displayName}</h4>
                                        <p class="text-xs text-gray-400">ID: ${user.customId}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="acceptFriendRequest('${user.uid}')" class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg text-xs font-bold">قبول</button>
                                    <button onclick="rejectFriendRequest('${user.uid}')" class="px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg text-xs font-bold">رفض</button>
                                    <button onclick="blockUser('${user.uid}')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-lg text-xs font-bold">حظر</button>
                                </div>
                            </div>
                        </div>`;
                }
            }
            lucide.createIcons();
        };

        window.rejectFriendRequest = async (uid) => {
            if (confirm('هل تريد رفض طلب الصداقة؟')) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), {
                    friendRequests: arrayRemove(uid)
                });
                
                await updateDoc(doc(db, "users", uid), {
                    sentRequests: arrayRemove(auth.currentUser.uid)
                });
                
                loadFriendRequests();
            }
        };

        async function loadFriends() {
            const list = document.getElementById('friendsList');
            if (!list) return;
            list.innerHTML = '';
            if (!userData.friends || userData.friends.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 dark:text-gray-500 text-sm py-4">لا يوجد أصدقاء بعد</p>';
                return;
            }
            for (const uid of userData.friends) {
                const snap = await getDoc(doc(db, "users", uid));
                if (snap.exists()) {
                    const friend = snap.data();
                    list.innerHTML += `
                        <div onclick="startChat('${friend.uid}')" class="glass-card p-4 rounded-3xl flex items-center justify-between cursor-pointer hover:bg-white dark:hover:bg-gray-800 transition">
                            <div class="flex items-center gap-3">
                                <img src="${friend.photoURL}" class="w-12 h-12 rounded-full object-cover">
                                <div>
                                    <h4 class="font-bold text-sm dark:text-white">${friend.displayName}</h4>
                                    <p class="text-xs text-gray-400">ID: ${friend.customId}</p>
                                </div>
                            </div>
                            <i data-lucide="message-circle" class="w-5 h-5 text-gray-300"></i>
                        </div>`;
                }
            }
            lucide.createIcons();
        }

        window.startChat = (friendId) => {
            window.location.href = `chat.html?friend=${friendId}`;
        };

        // Banner
        async function loadBanner() {
            try {
                const bDoc = await getDoc(doc(db, "appData", "banner"));
                const container = document.getElementById('homeBanner');
                if (bDoc.exists()) {
                    const b = bDoc.data();
                    container.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r ${b.gradient} opacity-80"></div><img src="${b.image}" class="absolute inset-0 w-full h-full object-cover opacity-50 mix-blend-overlay">`;
                } else {
                    container.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r from-blue-100 to-purple-100 opacity-80 dark:from-blue-900 dark:to-purple-900"></div>`;
                }
            } catch (error) {
                console.error("Error loading banner:", error);
            }
        }

        window.openNotifications = () => {
            alert('قريباً: شاشة الإشعارات');
        };

        // Initialize icons
        lucide.createIcons();
        setInterval(() => lucide.createIcons(), 1000);
    </script>
</body>
</html>
