<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary: #8b5cf6;
            --accent: #f59e0b;
            --bg-black: #000000;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.15);
            --wealth: #facc15;
            --magic: #d946ef;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: var(--bg-black);
            color: #fff; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±ÙˆÙ… Ø§Ù„ØµÙˆØªÙŠ */
        .room-container {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 10% 10%, #1e1b4b 0%, #000000 50%);
            z-index: 1000;
            display: none;
        }

        .room-container.active {
            display: block;
        }

        .mic-item {
            width: 62px; 
            height: 62px; 
            border-radius: 50%; 
            background: var(--glass);
            border: 1px solid var(--glass-border); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(5px); 
            transition: 0.3s;
        }

        .mic-img { 
            width: 90%; 
            height: 90%; 
            border-radius: 50%; 
            object-fit: cover; 
        }

        .msg-bubble {
            background: rgba(255,255,255,0.08); 
            border: 1px solid var(--glass-border);
            padding: 10px; 
            border-radius: 18px; 
            border-bottom-right-radius: 2px;
            backdrop-filter: blur(10px); 
            display: flex; 
            align-items: flex-start; 
            gap: 10px;
            max-width: 85%; 
            animation: slideIn 0.3s ease;
        }

        .msg-avatar { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            border: 1px solid var(--accent); 
            cursor: pointer; 
            transition: 0.2s; 
        }

        .badge { 
            font-size: 8px; 
            padding: 1px 6px; 
            border-radius: 10px; 
            font-weight: bold; 
        }
        
        .b-wealth { 
            background: var(--wealth); 
            color: #000; 
        }
        
        .b-magic { 
            background: var(--magic); 
            color: #fff; 
        }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Ø§Ù„Ø¨Ù†Ø± */
        .banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            opacity: 0.3;
            mix-blend-mode: overlay;
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tab-button {
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); 
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); 
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); 
            }
        }

        .room-pulse {
            animation: pulse 2s infinite;
        }

        .hidden { 
            display: none !important; 
        }

        .no-scrollbar::-webkit-scrollbar { 
            display: none; 
        }
        
        .no-scrollbar { 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }
    </style>
</head>
<body class="antialiased">
    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="mainPage" class="min-h-screen pb-24">
        
        <!-- Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="banner h-48 mx-4 mt-4 mb-6 rounded-2xl flex items-center justify-center relative">
            <div class="relative z-10 text-center">
                <h1 class="text-3xl font-bold mb-2">ğŸ¤ Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø­ÙŠØ©</h1>
                <p class="text-gray-300">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</p>
            </div>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="flex justify-center gap-4 mb-6 px-4">
            <button id="tabPublic" class="tab-button active" onclick="switchTab('public')">
                <i class="fas fa-globe ml-2"></i> Ø¹Ø§Ù…
            </button>
            <button id="tabPrivate" class="tab-button" onclick="switchTab('private')">
                <i class="fas fa-lock ml-2"></i> Ø®Ø§Øµ
            </button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« -->
        <div class="px-4 mb-6">
            <div class="glass-card rounded-2xl p-3 flex items-center">
                <i class="fas fa-search text-gray-400 mx-2"></i>
                <input type="text" 
                       id="roomSearch" 
                       placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ©..." 
                       class="flex-1 bg-transparent border-0 focus:outline-none text-white">
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
        <div id="publicRoomsSection" class="px-4">
            <h2 class="text-xl font-bold mb-4">ğŸ”Š Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
            
            <div id="publicRoomsList" class="grid grid-cols-2 gap-3 mb-8">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø±ÙˆÙ…Ø§Øª -->
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-comments text-3xl mb-3"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© -->
        <div id="privateRoomsSection" class="px-4 hidden">
            <!-- Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
            <div class="mb-6">
                <div class="glass-card rounded-2xl p-5 text-center cursor-pointer hover:bg-white/10 transition"
                     onclick="openCreateRoomModal()">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-plus text-white text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-1">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØªÙƒ Ø§Ù„Ø¢Ù†</h3>
                    <p class="text-sm text-gray-400">Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© ØµÙˆØªÙŠØ© Ø®Ø§ØµØ©</p>
                </div>
            </div>

            <h2 class="text-xl font-bold mb-4">ğŸ” ØºØ±ÙÙƒ Ø§Ù„Ø®Ø§ØµØ©</h2>
            
            <div id="privateRoomsList" class="space-y-3">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© -->
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users-slash text-3xl mb-3"></i>
                    <p>Ù„Ù… ØªÙ†Ø´Ø¦ Ø£ÙŠ ØºØ±Ù Ø®Ø§ØµØ© Ø¨Ø¹Ø¯</p>
                    <button onclick="openCreateRoomModal()" class="mt-4 px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition">
                        Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ ØºØ±ÙØ©
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ -->
        <nav class="glass fixed bottom-0 left-0 right-0 h-16 flex items-center justify-around border-t border-white/10">
            <button onclick="goToHome()" class="flex flex-col items-center text-blue-400">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </button>
            <button onclick="goToFriends()" class="flex flex-col items-center text-gray-400 hover:text-white">
                <i class="fas fa-user-friends text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span>
            </button>
            <button onclick="goToProfile()" class="flex flex-col items-center text-gray-400 hover:text-white">
                <i class="fas fa-user text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ù…Ù„Ù</span>
            </button>
            <button onclick="goToChat()" class="flex flex-col items-center text-gray-400 hover:text-white">
                <i class="fas fa-comment text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            </button>
        </nav>
    </div>

    <!-- Ø§Ù„Ø±ÙˆÙ… Ø§Ù„ØµÙˆØªÙŠ -->
    <div id="roomPage" class="room-container">
        <div class="app-container w-full h-full flex flex-col">
            <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±ÙˆÙ… -->
            <header class="header p-4 flex justify-between items-center border-b border-white/10">
                <div class="room-info glass rounded-3xl p-2 flex items-center gap-2 cursor-pointer">
                    <img id="roomOwnerAvatar" src="" class="owner-img w-10 h-10 rounded-full border-2 border-accent">
                    <div>
                        <span class="text-xs text-accent" id="roomOwnerId">ID: ---</span>
                        <div class="text-sm font-bold" id="roomTitle">---</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn-control w-10 h-10 rounded-full glass flex items-center justify-center" onclick="toggleFullscreen()">
                        <i class="fa-solid fa-expand"></i>
                    </button>
                    <button class="btn-control w-10 h-10 rounded-full bg-red-500 flex items-center justify-center" onclick="leaveRoom()">
                        <i class="fa-solid fa-phone-slash"></i>
                    </button>
                </div>
            </header>

            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ÙŠÙƒØ§Øª -->
            <div class="mics-grid flex-1 p-4 overflow-y-auto">
                <div id="micsGrid" class="flex flex-wrap justify-center gap-4">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
                </div>
            </div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª -->
            <div class="chat-area flex-1 overflow-y-auto p-4" id="chatArea">
                <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>

            <!-- Ø§Ù„ÙÙˆØªØ± -->
            <footer class="footer p-4 border-t border-white/10">
                <div class="flex items-center gap-2">
                    <div class="input-box flex-1 glass rounded-3xl p-2 flex items-center">
                        <input type="text" 
                               id="chatInput" 
                               class="main-input flex-1 bg-transparent border-0 focus:outline-none text-white" 
                               placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                    </div>
                    <button id="giftBtn" class="btn-action w-12 h-12 rounded-full glass flex items-center justify-center" onclick="openGiftSheet()">
                        <i class="fa-solid fa-gift text-accent"></i>
                    </button>
                    <button id="sendBtn" class="btn-action w-12 h-12 rounded-full bg-primary flex items-center justify-center" onclick="sendMessage()">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
    <div id="createRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© ØµÙˆØªÙŠØ©</h3>
                <button onclick="closeCreateRoomModal()" class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</label>
                    <input type="text" 
                           id="roomNameInput" 
                           placeholder="Ù…Ø«Ø§Ù„: Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡" 
                           class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm mb-2">ØµÙˆØ±Ø© Ø§Ù„ØºØ±ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" 
                           id="roomImageInput" 
                           placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" 
                           class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</p>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ©</label>
                    <select id="roomTypeInput" class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                        <option value="private">Ø®Ø§Øµ</option>
                        <option value="public">Ø¹Ø§Ù…</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</label>
                    <select id="maxUsersInput" class="w-full p-3 rounded-2xl glass border border-white/10 focus:border-accent focus:outline-none">
                        <option value="5">5 Ø£Ø´Ø®Ø§Øµ</option>
                        <option value="10" selected>10 Ø£Ø´Ø®Ø§Øµ</option>
                        <option value="20">20 Ø´Ø®ØµØ§Ù‹</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="closeCreateRoomModal()" 
                            class="flex-1 py-3 rounded-2xl bg-white/10 hover:bg-white/20 transition">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button onclick="createRoom()" 
                            class="flex-1 py-3 rounded-2xl bg-gradient-to-r from-blue-500 to-purple-500 hover:opacity-90 transition">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© -->
    <div id="giftSheet" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</h3>
                <button onclick="closeGiftSheet()" class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="user-selector flex gap-3 overflow-x-auto pb-3 mb-3 border-b border-white/10">
                <!-- Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø±ÙˆÙ… -->
            </div>
            
            <div class="gifts-grid grid grid-cols-4 gap-2 max-h-64 overflow-y-auto">
                <!-- Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ -->
                <div class="gift-card glass rounded-xl p-3 text-center cursor-pointer">
                    <div class="text-2xl mb-1">ğŸŒ¹</div>
                    <div class="text-xs">50 ğŸ’°</div>
                </div>
                <div class="gift-card glass rounded-xl p-3 text-center cursor-pointer">
                    <div class="text-2xl mb-1">ğŸ’</div>
                    <div class="text-xs">100 ğŸ’°</div>
                </div>
                <div class="gift-card glass rounded-xl p-3 text-center cursor-pointer">
                    <div class="text-2xl mb-1">ğŸ</div>
                    <div class="text-xs">200 ğŸ’°</div>
                </div>
                <div class="gift-card glass rounded-xl p-3 text-center cursor-center cursor-pointer">
                    <div class="text-2xl mb-1">ğŸ‘‘</div>
                    <div class="text-xs">500 ğŸ’°</div>
                </div>
            </div>
            
            <div class="flex items-center justify-between mt-4">
                <div class="text-sm">
                    Ø±ØµÙŠØ¯Ùƒ: <span class="text-accent font-bold" id="userBalance">0</span> ğŸ’°
                </div>
                <button onclick="sendGift()" class="px-4 py-2 rounded-xl bg-accent hover:opacity-90 transition">
                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb",
            databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com/"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let currentUser = null;
        let currentUserData = null;
        let currentRoom = null;
        let roomData = null;
        let localStream = null;
        let peerConnections = {};
        let isMuted = false;
        let selectedGift = null;
        let selectedRecipient = null;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData();
                    await checkCurrentRoom();
                    await loadRooms();
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    window.location.href = 'login.html';
                }
            });
        });

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    document.getElementById('userBalance').textContent = currentUserData.balance || 0;
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ ØºØ±ÙØ© Ù†Ø´Ø·Ø©
                    if (currentUserData.currentRoom) {
                        currentRoom = currentUserData.currentRoom;
                        await joinExistingRoom(currentRoom);
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        async function checkCurrentRoom() {
            if (!currentUserData || !currentUserData.currentRoom) return;
            
            try {
                const roomDoc = await db.collection('rooms').doc(currentUserData.currentRoom).get();
                if (roomDoc.exists) {
                    currentRoom = currentUserData.currentRoom;
                    await joinExistingRoom(currentRoom);
                } else {
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    await db.collection('users').doc(currentUser.uid).update({
                        currentRoom: null
                    });
                }
            } catch (error) {
                console.error('Error checking current room:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª
        async function loadRooms() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                const publicRoomsSnap = await db.collection('rooms')
                    .where('type', '==', 'public')
                    .where('isActive', '==', true)
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                displayPublicRooms(publicRoomsSnap.docs);
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (currentUserData && currentUserData.joinedRooms) {
                    loadPrivateRooms();
                }
                
            } catch (error) {
                console.error('Error loading rooms:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª', 'error');
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        function displayPublicRooms(rooms) {
            const publicRoomsList = document.getElementById('publicRoomsList');
            
            if (rooms.length === 0) {
                publicRoomsList.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500">
                        <i class="fas fa-comments text-3xl mb-3"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        <button onclick="openCreateRoomModal()" class="mt-4 px-4 py-2 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition">
                            Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ Ø±ÙˆÙ…
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            rooms.forEach(roomDoc => {
                const room = roomDoc.data();
                const isFull = room.users?.length >= room.maxUsers;
                const isInRoom = room.users?.some(u => u.uid === currentUser?.uid);
                
                html += `
                    <div class="glass-card rounded-2xl overflow-hidden cursor-pointer" onclick="previewRoom('${roomDoc.id}')">
                        <div class="h-32 relative">
                            <img src="${room.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                                 class="w-full h-full object-cover">
                            <div class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded-lg text-xs">
                                ${room.users?.length || 0}/${room.maxUsers}
                            </div>
                        </div>
                        <div class="p-3">
                            <h4 class="font-bold text-sm truncate">${room.name}</h4>
                            <div class="flex items-center gap-2 mt-2">
                                <img src="${room.ownerAvatar}" class="w-6 h-6 rounded-full">
                                <span class="text-xs text-gray-400">${room.ownerName}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            publicRoomsList.innerHTML = html;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
        async function loadPrivateRooms() {
            try {
                const privateRoomsList = document.getElementById('privateRoomsList');
                
                // Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const createdRoomsSnap = await db.collection('rooms')
                    .where('ownerId', '==', currentUser.uid)
                    .where('type', '==', 'private')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (createdRoomsSnap.empty) {
                    privateRoomsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-users-slash text-3xl mb-3"></i>
                            <p>Ù„Ù… ØªÙ†Ø´Ø¦ Ø£ÙŠ ØºØ±Ù Ø®Ø§ØµØ© Ø¨Ø¹Ø¯</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                createdRoomsSnap.forEach(doc => {
                    const room = doc.data();
                    
                    html += `
                        <div class="glass-card rounded-2xl p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img src="${room.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                                     class="w-12 h-12 rounded-lg object-cover">
                                <div>
                                    <h4 class="font-bold">${room.name}</h4>
                                    <p class="text-xs text-gray-400">${room.users?.length || 0} Ø£Ø¹Ø¶Ø§Ø¡</p>
                                </div>
                            </div>
                            <button onclick="joinRoom('${doc.id}')" class="px-3 py-1 rounded-lg bg-blue-500 hover:bg-blue-600 transition text-sm">
                                Ø¯Ø®ÙˆÙ„
                            </button>
                        </div>
                    `;
                });

                privateRoomsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading private rooms:', error);
            }
        }

        // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙˆÙ…
        async function previewRoom(roomId) {
            try {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                
                if (!roomDoc.exists) {
                    showNotification('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                const room = roomDoc.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©
                if (room.users?.length >= room.maxUsers) {
                    showNotification('Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©', 'warning');
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØºØ±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹
                if (currentRoom) {
                    if (confirm('Ø£Ù†Øª ÙÙŠ ØºØ±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ÙˆØ§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                        await leaveCurrentRoom();
                        await joinRoom(roomId);
                    }
                } else {
                    await joinRoom(roomId);
                }
                
            } catch (error) {
                console.error('Error previewing room:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±ÙˆÙ…
        async function joinRoom(roomId) {
            try {
                showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©...', 'info');
                
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                if (!roomDoc.exists) {
                    showNotification('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                const room = roomDoc.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØºØ±ÙØ© Ø£Ø®Ø±Ù‰
                if (currentUserData.currentRoom && currentUserData.currentRoom !== roomId) {
                    if (!confirm('Ù„Ø¯ÙŠÙƒ ØºØ±ÙØ© Ù†Ø´Ø·Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±ØªÙ‡Ø§ ÙˆØ§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                        return;
                    }
                    await leaveCurrentRoom();
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
                const userExists = room.users?.some(u => u.uid === currentUser.uid);
                
                if (!userExists) {
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØºØ±ÙØ©
                    const userData = {
                        uid: currentUser.uid,
                        name: currentUserData.displayName,
                        avatar: currentUserData.photoURL,
                        isMuted: false,
                        isSpeaker: true,
                        joinedAt: new Date(),
                        magicLevel: currentUserData.magicLevel || 1,
                        wealthLevel: currentUserData.wealthLevel || 1
                    };

                    await db.collection('rooms').doc(roomId).update({
                        users: firebase.firestore.FieldValue.arrayUnion(userData)
                    });
                }

                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    currentRoom: roomId,
                    joinedRooms: firebase.firestore.FieldValue.arrayUnion(roomId)
                });

                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                currentRoom = roomId;
                roomData = room;
                
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                document.getElementById('mainPage').style.display = 'none';
                document.getElementById('roomPage').classList.add('active');
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±ÙˆÙ…
                updateRoomUI();
                
                // Ø¨Ø¯Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                await startWebRTCConnection();
                
                showNotification(`ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù€ ${room.name}`, 'success');
                
            } catch (error) {
                console.error('Error joining room:', error);
                showNotification(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø±ÙˆÙ… Ù…ÙˆØ¬ÙˆØ¯
        async function joinExistingRoom(roomId) {
            try {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                if (roomDoc.exists) {
                    roomData = roomDoc.data();
                    
                    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                    document.getElementById('mainPage').style.display = 'none';
                    document.getElementById('roomPage').classList.add('active');
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±ÙˆÙ…
                    updateRoomUI();
                    
                    // Ø¨Ø¯Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                    await startWebRTCConnection();
                }
            } catch (error) {
                console.error('Error joining existing room:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±ÙˆÙ…
        function updateRoomUI() {
            if (!roomData) return;
            
            document.getElementById('roomTitle').textContent = roomData.name;
            document.getElementById('roomOwnerAvatar').src = roomData.ownerAvatar;
            document.getElementById('roomOwnerId').textContent = `ID: ${roomData.ownerId?.substring(0, 6)}`;
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            updateMicsGrid();
        }

        // ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†Ø§Øª
        function updateMicsGrid() {
            if (!roomData || !roomData.users) return;
            
            const micsGrid = document.getElementById('micsGrid');
            micsGrid.innerHTML = '';
            
            roomData.users.forEach(user => {
                const micItem = document.createElement('div');
                micItem.className = 'mic-item flex flex-col items-center';
                micItem.innerHTML = `
                    <div class="avatar-ring" onclick="showUserProfile('${user.uid}')">
                        <img src="${user.avatar}" class="mic-img">
                    </div>
                    <span style="font-size:10px; color:#aaa; margin-top:5px">${user.name}</span>
                `;
                micsGrid.appendChild(micItem);
            });
        }

        // Ø¨Ø¯Ø¡ Ø§ØªØµØ§Ù„ WebRTC
        async function startWebRTCConnection() {
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // ØªÙƒÙˆÙŠÙ† ICE servers
                const rtcConfig = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };

                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¥Ø´Ø§Ø±Ø§Øª WebRTC Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
                listenForSignals();
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø¯Ø®ÙˆÙ„
                sendSignal('join', null);
                
            } catch (error) {
                console.error('Error starting WebRTC:', error);
                showNotification('ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'warning');
            }
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¥Ø´Ø§Ø±Ø§Øª WebRTC
        function listenForSignals() {
            if (!currentRoom) return;
            
            const signalsRef = rtdb.ref(`rooms/${currentRoom}/signals`);
            
            signalsRef.on('child_added', async (snapshot) => {
                const signal = snapshot.val();
                
                if (signal.userId === currentUser.uid) return;
                
                try {
                    if (signal.type === 'join') {
                        await handleUserJoin(signal.userId);
                    } else if (signal.type === 'offer') {
                        await handleOffer(signal.userId, signal.offer);
                    } else if (signal.type === 'answer') {
                        await handleAnswer(signal.userId, signal.answer);
                    } else if (signal.type === 'ice-candidate') {
                        await handleIceCandidate(signal.userId, signal.candidate);
                    } else if (signal.type === 'leave') {
                        handleUserLeave(signal.userId);
                    }
                } catch (error) {
                    console.error('Error handling signal:', error);
                }
            });
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¯Ø®ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        async function handleUserJoin(userId) {
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            peerConnections[userId] = pc;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±Ø´Ø­Ø§Øª ICE
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignalToUser(userId, 'ice-candidate', event.candidate);
                }
            };
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø¯
            pc.ontrack = (event) => {
                const audioElement = document.createElement('audio');
                audioElement.id = `audio-${userId}`;
                audioElement.autoplay = true;
                audioElement.controls = false;
                audioElement.style.display = 'none';
                document.body.appendChild(audioElement);
                audioElement.srcObject = event.streams[0];
            };
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§ØªØµØ§Ù„
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            sendSignalToUser(userId, 'offer', offer);
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØµØ§Ù„
        async function handleOffer(userId, offer) {
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            peerConnections[userId] = pc;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
            
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignalToUser(userId, 'ice-candidate', event.candidate);
                }
            };
            
            pc.ontrack = (event) => {
                const audioElement = document.createElement('audio');
                audioElement.id = `audio-${userId}`;
                audioElement.autoplay = true;
                audioElement.controls = false;
                audioElement.style.display = 'none';
                document.body.appendChild(audioElement);
                audioElement.srcObject = event.streams[0];
            };
            
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            sendSignalToUser(userId, 'answer', answer);
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        async function handleAnswer(userId, answer) {
            const pc = peerConnections[userId];
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±Ø´Ø­ ICE
        async function handleIceCandidate(userId, candidate) {
            const pc = peerConnections[userId];
            if (pc) {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø±ÙˆØ¬ Ù…Ø³ØªØ®Ø¯Ù…
        function handleUserLeave(userId) {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª
            const audioElement = document.getElementById(`audio-${userId}`);
            if (audioElement) {
                audioElement.remove();
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
            addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', `ØºØ§Ø¯Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØºØ±ÙØ©`, 'system');
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø©
        function sendSignal(type, data) {
            if (!currentRoom || !currentUser) return;
            
            const signalRef = rtdb.ref(`rooms/${currentRoom}/signals`).push();
            signalRef.set({
                type: type,
                userId: currentUser.uid,
                data: data,
                timestamp: Date.now()
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯
        function sendSignalToUser(targetUserId, type, data) {
            if (!currentRoom || !currentUser) return;
            
            const signalRef = rtdb.ref(`rooms/${currentRoom}/signals`).push();
            signalRef.set({
                type: type,
                userId: currentUser.uid,
                targetUserId: targetUserId,
                data: data,
                timestamp: Date.now()
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
                addChatMessage(currentUserData.displayName, text, 'user');
                
                // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await db.collection('rooms').doc(currentRoom)
                    .collection('messages')
                    .add({
                        senderId: currentUser.uid,
                        senderName: currentUserData.displayName,
                        senderAvatar: currentUserData.photoURL,
                        text: text,
                        timestamp: new Date()
                    });
                
                input.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
        function addChatMessage(sender, text, type = 'user') {
            const chatArea = document.getElementById('chatArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'msg-bubble mb-3';
            
            // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            if (type === 'system') {
                messageDiv.style.background = 'rgba(59, 130, 246, 0.2)';
            } else if (type === 'user') {
                messageDiv.style.background = 'rgba(139, 92, 246, 0.2)';
            }
            
            messageDiv.innerHTML = `
                <div class="msg-content">
                    <div class="msg-user">
                        ${sender}
                    </div>
                    <div class="msg-text">${text}</div>
                </div>
            `;
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø±ÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
        async function leaveCurrentRoom() {
            if (!currentRoom) return;
            
            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù…ØºØ§Ø¯Ø±Ø©
                sendSignal('leave', null);
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
                Object.values(peerConnections).forEach(pc => pc.close());
                peerConnections = {};
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØºØ±ÙØ©
                if (roomData && roomData.users) {
                    const updatedUsers = roomData.users.filter(u => u.uid !== currentUser.uid);
                    
                    if (updatedUsers.length === 0) {
                        // Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¥Ø°Ø§ Ø£ØµØ¨Ø­Øª ÙØ§Ø±ØºØ©
                        await db.collection('rooms').doc(currentRoom).delete();
                        await rtdb.ref(`rooms/${currentRoom}`).remove();
                    } else {
                        await db.collection('rooms').doc(currentRoom).update({
                            users: updatedUsers
                        });
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    currentRoom: null
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                currentRoom = null;
                roomData = null;
                
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                document.getElementById('roomPage').classList.remove('active');
                document.getElementById('mainPage').style.display = 'block';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆÙ…Ø§Øª
                await loadRooms();
                
                showNotification('ØªÙ… Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©', 'success');
                
            } catch (error) {
                console.error('Error leaving room:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
        async function createRoom() {
            try {
                const roomName = document.getElementById('roomNameInput').value.trim();
                const roomImage = document.getElementById('roomImageInput').value.trim();
                const roomType = document.getElementById('roomTypeInput').value;
                const maxUsers = parseInt(document.getElementById('maxUsersInput').value);
                
                if (!roomName) {
                    showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„ØºØ±ÙØ©', 'warning');
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ØºØ±ÙØ© Ù†Ø´Ø·Ø©
                if (currentUserData.currentRoom) {
                    showNotification('Ù„Ø¯ÙŠÙƒ ØºØ±ÙØ© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ¬Ø¨ Ù…ØºØ§Ø¯Ø±ØªÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                    return;
                }

                showNotification('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©...', 'info');
                
                // Ø¥Ù†Ø´Ø§Ø¡ ID Ù„Ù„ØºØ±ÙØ©
                const roomId = generateRoomId();
                
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ©
                const roomData = {
                    id: roomId,
                    name: roomName,
                    image: roomImage || '',
                    type: roomType,
                    ownerId: currentUser.uid,
                    ownerName: currentUserData.displayName,
                    ownerAvatar: currentUserData.photoURL,
                    maxUsers: maxUsers,
                    users: [{
                        uid: currentUser.uid,
                        name: currentUserData.displayName,
                        avatar: currentUserData.photoURL,
                        isMuted: false,
                        isSpeaker: true,
                        joinedAt: new Date(),
                        magicLevel: currentUserData.magicLevel || 1,
                        wealthLevel: currentUserData.wealthLevel || 1,
                        isOwner: true
                    }],
                    createdAt: new Date(),
                    isActive: true,
                    currentSpeakers: 1
                };

                // Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ© ÙÙŠ Firestore
                await db.collection('rooms').doc(roomId).set(roomData);
                
                // Ø¥Ù†Ø´Ø§Ø¡ node ÙÙŠ Realtime Database Ù„Ù„Ø¥Ø´Ø§Ø±Ø§Øª
                await rtdb.ref(`rooms/${roomId}/signals`).set({});
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    currentRoom: roomId,
                    createdRooms: firebase.firestore.FieldValue.arrayUnion(roomId),
                    joinedRooms: firebase.firestore.FieldValue.arrayUnion(roomId)
                });

                closeCreateRoomModal();
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ù…Ø¨Ø§Ø´Ø±Ø©
                currentRoom = roomId;
                await joinRoom(roomId);
                
            } catch (error) {
                console.error('Error creating room:', error);
                showNotification(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©', 'error');
            }
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        function switchTab(tab) {
            const publicTabBtn = document.getElementById('tabPublic');
            const privateTabBtn = document.getElementById('tabPrivate');
            const publicSection = document.getElementById('publicRoomsSection');
            const privateSection = document.getElementById('privateRoomsSection');
            
            if (tab === 'public') {
                publicTabBtn.classList.add('active');
                privateTabBtn.classList.remove('active');
                publicSection.classList.remove('hidden');
                privateSection.classList.add('hidden');
            } else {
                publicTabBtn.classList.remove('active');
                privateTabBtn.classList.add('active');
                publicSection.classList.add('hidden');
                privateSection.classList.remove('hidden');
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
                loadPrivateRooms();
            }
        }

        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
        function openCreateRoomModal() {
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('roomNameInput').value = '';
            document.getElementById('roomImageInput').value = '';
            document.getElementById('roomTypeInput').value = 'private';
            document.getElementById('maxUsersInput').value = '10';
            
            document.getElementById('createRoomModal').classList.add('active');
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
        function closeCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('active');
        }

        // ÙØªØ­ Ø´ÙŠØª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
        function openGiftSheet() {
            if (!currentRoom || !roomData || !roomData.users) return;
            
            const userSelector = document.querySelector('.user-selector');
            userSelector.innerHTML = '';
            
            // Ø¹Ø±Ø¶ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø±ÙˆÙ…
            roomData.users.forEach(user => {
                if (user.uid === currentUser.uid) return;
                
                const userOption = document.createElement('div');
                userOption.className = 'flex flex-col items-center cursor-pointer';
                userOption.onclick = () => {
                    selectedRecipient = user;
                    document.querySelectorAll('.user-selector > div').forEach(el => {
                        el.classList.remove('border-accent');
                    });
                    userOption.classList.add('border-accent');
                };
                
                userOption.innerHTML = `
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full border-2 border-transparent mb-1">
                    <span class="text-xs">${user.name}</span>
                `;
                
                userSelector.appendChild(userOption);
            });
            
            document.getElementById('giftSheet').classList.add('active');
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø´ÙŠØª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
        function closeGiftSheet() {
            document.getElementById('giftSheet').classList.remove('active');
            selectedGift = null;
            selectedRecipient = null;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©
        async function sendGift() {
            if (!selectedGift || !selectedRecipient) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯ÙŠØ© ÙˆÙ…Ø³ØªÙ„Ù…', 'warning');
                return;
            }

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
                if (currentUserData.balance < selectedGift.price) {
                    showNotification('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ', 'warning');
                    return;
                }

                // Ø®ØµÙ… Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„
                await db.collection('users').doc(currentUser.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-selectedGift.price)
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯ÙŠØ© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                const giftData = {
                    giftId: selectedGift.id,
                    giftName: selectedGift.name,
                    giftIcon: selectedGift.icon,
                    senderId: currentUser.uid,
                    senderName: currentUserData.displayName,
                    receiverId: selectedRecipient.uid,
                    receiverName: selectedRecipient.name,
                    price: selectedGift.price,
                    sentAt: new Date()
                };

                await db.collection('gifts').add(giftData);
                
                // Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±Ø© Ø§Ù„Ø³Ø­Ø± Ù„Ù„Ù…Ø±Ø³Ù„
                await db.collection('users').doc(currentUser.uid).update({
                    magicExp: firebase.firestore.FieldValue.increment(selectedGift.price * 0.1)
                });

                // Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±Ø© Ø§Ù„Ø«Ø±ÙˆØ© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                await db.collection('users').doc(selectedRecipient.uid).update({
                    wealthExp: firebase.firestore.FieldValue.increment(selectedGift.price * 0.05)
                });

                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
                addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', `ğŸ Ø£Ø±Ø³Ù„ ${currentUserData.displayName} Ù‡Ø¯ÙŠØ© Ù„Ù€ ${selectedRecipient.name}`, 'system');
                
                // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆÙ…
                await db.collection('rooms').doc(currentRoom)
                    .collection('messages')
                    .add({
                        type: 'gift',
                        giftData: giftData,
                        timestamp: new Date()
                    });

                // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ø¯ÙŠØ©
                showGiftEffect(selectedGift.icon);
                
                closeGiftSheet();
                showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await loadUserData();
                
            } catch (error) {
                console.error('Error sending gift:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©', 'error');
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ø¯ÙŠØ©
        function showGiftEffect(giftIcon) {
            const effect = document.createElement('div');
            effect.className = 'fixed inset-0 flex items-center justify-center pointer-events-none z-3000';
            effect.innerHTML = `
                <div class="text-6xl animate-ping">${giftIcon}</div>
            `;
            
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1500);
        }

        // ØªÙˆÙ„ÙŠØ¯ ID Ù„Ù„ØºØ±ÙØ©
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-xl z-50 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„
        function goToHome() {
            if (currentRoom) {
                if (confirm('Ø£Ù†Øª ÙÙŠ ØºØ±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ')) {
                    leaveCurrentRoom();
                }
            }
        }

        function goToFriends() {
            showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡', 'info');
        }

        function goToProfile() {
            showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'info');
        }

        function goToChat() {
            showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©', 'info');
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±ÙˆÙ…
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(console.error);
            } else {
                document.exitFullscreen();
            }
        }

        function leaveRoom() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                leaveCurrentRoom();
            }
        }

        function showUserProfile(userId) {
            showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'info');
        }

        // Ù…Ù†Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙØ§Ø¬Ø¦
        window.addEventListener('beforeunload', async (e) => {
            if (currentRoom) {
                e.preventDefault();
                e.returnValue = 'Ø£Ù†Øª ÙÙŠ ØºØ±ÙØ© ØµÙˆØªÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
                await leaveCurrentRoom();
            }
        });
    </script>
</body>
</html>
