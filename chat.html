<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans Arabic', sans-serif;
            touch-action: manipulation;
        }

        body {
            background: #f8fafc;
            color: #1f2937;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Global Banner - Side Slide Animation */
        #globalBanner {
            position: fixed;
            top: 20%;
            right: -100%; /* Start outside */
            width: 320px;
            height: 80px;
            z-index: 1000;
            transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        #globalBanner.active {
            right: 10px;
        }

        .banner-bg {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Natural size */
        }

        /* Chat Bubbles */
        .chat-bubble-me {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border-radius: 20px 20px 4px 20px;
        }

        .chat-bubble-them {
            background: white;
            color: #374151;
            border-radius: 20px 20px 20px 4px;
            border: 1px solid #e2e8f0;
        }

        /* Floating Gift Style */
        .gift-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
            animation: giftPop 0.5s ease;
        }
        @keyframes giftPop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .gift-img-main {
            width: 120px;
            height: 120px;
            object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }

        /* Profile Sidebar/Modal Slide */
        #profileModal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: white;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        #profileModal.active {
            transform: translateX(0);
        }

        /* Presence Dot */
        .presence-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 0;
            right: 0;
        }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- Global Side Banner -->
    <div id="globalBanner">
        <img id="bannerBg" src="" class="banner-bg">
        <div class="relative z-10 flex items-center justify-between h-full px-4">
            <div class="flex flex-col items-center">
                <img id="bSender" src="" class="w-8 h-8 rounded-full border border-white">
                <span id="nSender" class="text-[9px] text-white font-bold truncate w-12 text-center"></span>
            </div>
            <img id="bGift" src="" class="w-10 h-10 object-contain mx-1">
            <div class="flex flex-col items-center">
                <img id="bReceiver" src="" class="w-8 h-8 rounded-full border border-white">
                <span id="nReceiver" class="text-[9px] text-white font-bold truncate w-12 text-center"></span>
            </div>
        </div>
    </div>

    <!-- Friend List Header -->
    <header class="h-16 bg-white border-b flex items-center justify-between px-5 shrink-0">
        <button onclick="goBack()"><i data-lucide="chevron-right"></i></button>
        <h1 class="font-bold text-lg">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h1>
        <div class="w-10"></div>
    </header>

    <!-- Main Content -->
    <main id="friendsContainer" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
        <!-- Friends Loaded Here -->
    </main>

    <!-- Chat View -->
    <div id="chatModal" class="fixed inset-0 bg-slate-50 z-50 hidden flex flex-col">
        <header class="h-16 bg-white border-b flex items-center justify-between px-4">
            <div class="flex items-center gap-3">
                <button onclick="closeChat()"><i data-lucide="arrow-right"></i></button>
                <div class="flex items-center gap-2 cursor-pointer" onclick="openProfile(currentFriend.uid)">
                    <div class="relative">
                        <img id="cAvatar" src="" class="w-10 h-10 rounded-full border bg-gray-100">
                        <div id="cStatus" class="presence-dot bg-gray-400"></div>
                    </div>
                    <div>
                        <div id="cName" class="font-bold text-sm">...</div>
                        <div id="cStatusText" class="text-[10px] text-gray-400">ØºÙŠØ± Ù…ØªØµÙ„</div>
                    </div>
                </div>
            </div>
            <button onclick="openProfile(currentFriend.uid)"><i data-lucide="info" class="text-gray-400"></i></button>
        </header>

        <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"></div>

        <div class="p-3 bg-white border-t">
            <div class="flex items-center gap-2 bg-gray-100 rounded-full px-3 py-1">
                <button onclick="toggleGiftBox(true)">
                    <img src="https://i.postimg.cc/Y0MLWDL5/sv.webp" class="w-8 h-8 hover:scale-110 transition">
                </button>
                <input type="text" id="mInput" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹..." class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-2">
                <button onclick="sendMsg()" class="bg-blue-600 text-white p-2 rounded-full"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profileModal" class="no-scrollbar overflow-y-auto">
        <div class="relative h-40 bg-gradient-to-b from-blue-600 to-blue-400">
            <button onclick="closeProfile()" class="absolute top-4 left-4 p-2 bg-black/20 rounded-full text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="px-6 -mt-12 text-center relative">
            <div class="inline-block relative">
                <img id="pAvatar" src="" class="w-24 h-24 rounded-full border-4 border-white mx-auto bg-gray-200">
                <div id="pFrame" class="absolute inset-[-8px]"></div>
            </div>
            <h2 id="pName" class="text-xl font-bold mt-2">...</h2>
            <div class="flex justify-center gap-2 mt-1">
                <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded">ID: <span id="pId">0</span></span>
                <span id="pWealthBadge" class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">Ø«Ø±ÙˆØ©: <span id="pWealthLv">1</span></span>
                <span id="pMagicBadge" class="text-[10px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-bold">Ø³Ø­Ø±: <span id="pMagicLv">1</span></span>
            </div>

            <div class="mt-8 text-right">
                <h3 class="font-bold text-sm mb-3">Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</h3>
                <div id="pGiftsGrid" class="grid grid-cols-5 gap-2 bg-gray-50 p-3 rounded-xl min-h-[80px]">
                    <!-- Real Gifts Sync -->
                </div>
            </div>

            <div class="mt-8 mb-10 text-right">
                <h3 class="font-bold text-sm mb-3">Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</h3>
                <div class="p-4 rounded-xl border-2 border-dashed border-pink-200 bg-pink-50 flex items-center justify-between opacity-60">
                    <span class="text-xs text-pink-500">Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹</span>
                    <i data-lucide="heart" class="text-pink-300"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Picker -->
    <div id="giftPicker" class="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm hidden flex-col justify-end" onclick="toggleGiftBox(false)">
        <div class="bg-white rounded-t-3xl p-5 max-h-[60vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-4"></div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</h3>
                <div class="text-xs font-bold text-blue-600">Ø±ØµÙŠØ¯Ùƒ: <span id="uBalance">0</span> ðŸ’°</div>
            </div>
            <div id="giftGrid" class="grid grid-cols-4 gap-3 overflow-y-auto no-scrollbar flex-1 pb-20"></div>
            <button id="sendGiftBtn" onclick="doSendGift()" class="w-full py-3 mt-4 bg-gray-200 text-gray-400 rounded-xl font-bold disabled:opacity-50">Ø§Ø®ØªØ± Ù‡Ø¯ÙŠØ©</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, push, onValue, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb",
            databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        let userMe = null;
        let currentFriend = null;
        let chatSub = null;
        let selectedGift = null;
        const banners = { 
            silver: "https://i.postimg.cc/23fY6g1g/sm.webp", 
            gold: "https://i.postimg.cc/QVrDtvF2/sn.webp", 
            diamond: "https://i.postimg.cc/Z0hmRXWg/so.webp" 
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Realtime sync of user data
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userMe = { uid: user.uid, ...snap.data() };
                    loadFriendsList();
                    document.getElementById('uBalance').innerText = userMe.balance.toLocaleString();
                });

                // Global Banner Listener
                onValue(ref(rtdb, 'globalBanners'), (snap) => {
                    const data = snap.val();
                    if(!data) return;
                    const last = Object.values(data).pop();
                    if(Date.now() - last.timestamp < 5000) showBanner(last);
                });

                // Online Status
                const statusRef = ref(rtdb, 'status/' + user.uid);
                set(ref(rtdb, '.info/connected'), true);
                onDisconnect(statusRef).set({ state: 'offline', last: serverTimestamp() });
                set(statusRef, { state: 'online', last: serverTimestamp() });
            }
        });

        async function loadFriendsList() {
            const container = document.getElementById('friendsContainer');
            container.innerHTML = '';
            if(!userMe.friends) return;
            for(let fid of userMe.friends) {
                const fSnap = await getDoc(doc(db, "users", fid));
                if(fSnap.exists()) {
                    const f = fSnap.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-3 rounded-2xl flex items-center justify-between shadow-sm border cursor-pointer";
                    card.innerHTML = `
                        <div class="flex items-center gap-3" onclick="openChat('${f.uid}')">
                            <img src="${f.photoURL}" class="w-12 h-12 rounded-full border">
                            <div>
                                <div class="font-bold text-sm">${f.displayName}</div>
                                <div class="text-[10px] text-gray-400">Ø§Ù†Ù‚Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                }
            }
            lucide.createIcons();
        }

        window.openChat = async (uid) => {
            const snap = await getDoc(doc(db, "users", uid));
            currentFriend = snap.data();
            document.getElementById('cName').innerText = currentFriend.displayName;
            document.getElementById('cAvatar').src = currentFriend.photoURL;
            document.getElementById('chatModal').classList.remove('hidden');

            // Presence
            onValue(ref(rtdb, 'status/' + uid), (s) => {
                const st = s.val();
                const dot = document.getElementById('cStatus');
                const txt = document.getElementById('cStatusText');
                if(st?.state === 'online') {
                    dot.className = "presence-dot bg-green-500";
                    txt.innerText = "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
                } else {
                    dot.className = "presence-dot bg-gray-400";
                    txt.innerText = "ØºÙŠØ± Ù…ØªØµÙ„";
                }
            });

            // Chat Messages
            const cid = [auth.currentUser.uid, uid].sort().join('_');
            if(chatSub) chatSub();
            chatSub = onValue(ref(rtdb, `chats/${cid}/messages`), (snap) => {
                const box = document.getElementById('chatBox');
                box.innerHTML = '';
                const msgs = snap.val();
                if(!msgs) return;
                Object.values(msgs).forEach(m => {
                    const isMe = m.senderId === auth.currentUser.uid;
                    const d = document.createElement('div');
                    if(m.type === 'gift') {
                        d.className = "gift-wrapper";
                        d.innerHTML = `<img src="${m.giftImage}" class="gift-img-main">
                                       <span class="text-[10px] font-bold text-blue-600 mt-1">${m.giftName}</span>`;
                    } else {
                        d.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                        d.innerHTML = `<div class="max-w-[80%] p-3 text-sm ${isMe ? 'chat-bubble-me' : 'chat-bubble-them'}">${m.text}</div>`;
                    }
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.closeChat = () => {
            document.getElementById('chatModal').classList.add('hidden');
            if(chatSub) chatSub();
        };

        window.openProfile = async (uid) => {
            const snap = await getDoc(doc(db, "users", uid));
            const p = snap.data();
            document.getElementById('pName').innerText = p.displayName;
            document.getElementById('pAvatar').src = p.photoURL;
            document.getElementById('pId').innerText = p.customId || "0";
            document.getElementById('pWealthLv').innerText = p.wealthLevel || 1;
            document.getElementById('pMagicLv').innerText = p.magicLevel || 1;
            
            // Sync Received Gifts
            const grid = document.getElementById('pGiftsGrid');
            grid.innerHTML = '';
            if(p.receivedGifts) {
                Object.entries(p.receivedGifts).forEach(([gid, count]) => {
                    grid.innerHTML += `<div class="flex flex-col items-center">
                        <img src="${gid}" class="w-8 h-8 object-contain">
                        <span class="text-[8px]">x${count}</span>
                    </div>`;
                });
            } else {
                grid.innerHTML = '<div class="col-span-5 text-center text-[9px] text-gray-300 py-4">Ù„Ø§ Ù‡Ø¯Ø§ÙŠØ§</div>';
            }

            document.getElementById('profileModal').classList.add('active');
        };

        window.closeProfile = () => document.getElementById('profileModal').classList.remove('active');

        window.toggleGiftBox = (show) => {
            const el = document.getElementById('giftPicker');
            el.classList.toggle('hidden', !show);
            if(show) loadGifts();
        };

        async function loadGifts() {
            const grid = document.getElementById('giftGrid');
            grid.innerHTML = '';
            // Load from both wealth and magic collections
            const wGifts = await getDoc(doc(db, "app", "store")); // Assuming a store doc or query collection
            // Simplification: use a static list or fetch from collection
            const snaps = await onSnapshot(collection(db, "gifts"), (s) => {
                grid.innerHTML = '';
                s.docs.forEach(doc => {
                    const g = doc.data();
                    const d = document.createElement('div');
                    d.className = "flex flex-col items-center p-2 bg-gray-50 rounded-xl border border-transparent";
                    d.innerHTML = `<img src="${g.image}" class="w-10 h-10 object-contain"><span class="text-[9px] font-bold mt-1">${g.name}</span><span class="text-[8px] text-blue-500">${g.price.toLocaleString()}</span>`;
                    d.onclick = () => {
                        selectedGift = g;
                        document.querySelectorAll('#giftGrid > div').forEach(x => x.classList.remove('border-blue-500', 'bg-blue-50'));
                        d.classList.add('border-blue-500', 'bg-blue-50');
                        document.getElementById('sendGiftBtn').disabled = userMe.balance < g.price;
                        document.getElementById('sendGiftBtn').innerText = `Ø¥Ø±Ø³Ø§Ù„ (${g.price.toLocaleString()})`;
                        document.getElementById('sendGiftBtn').className = "w-full py-3 mt-4 bg-blue-600 text-white rounded-xl font-bold";
                    };
                    grid.appendChild(d);
                });
            });
        }

        window.doSendGift = async () => {
            if(!selectedGift || userMe.balance < selectedGift.price) return;
            const gid = selectedGift.image; // Using image as ID for simple sync
            
            try {
                // 1. Pay
                await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-selectedGift.price) });
                
                // 2. Receive & Log for Profile
                await updateDoc(doc(db, "users", currentFriend.uid), { 
                    balance: increment(selectedGift.price),
                    [`receivedGifts.${btoa(gid).substring(0,10)}`]: increment(1), // Simple hash for path
                    [`receivedGiftsImages.${btoa(gid).substring(0,10)}`]: gid // Store image ref
                });

                // 3. Message
                const cid = [auth.currentUser.uid, currentFriend.uid].sort().join('_');
                await push(ref(rtdb, `chats/${cid}/messages`), {
                    senderId: auth.currentUser.uid,
                    type: 'gift',
                    giftImage: selectedGift.image,
                    giftName: selectedGift.name,
                    giftValue: selectedGift.price,
                    timestamp: serverTimestamp()
                });

                // 4. Global Banner
                if(selectedGift.price >= 80000) {
                    await push(ref(rtdb, 'globalBanners'), {
                        senderName: userMe.displayName,
                        senderImg: userMe.photoURL,
                        receiverName: currentFriend.displayName,
                        receiverImg: currentFriend.photoURL,
                        giftImg: selectedGift.image,
                        value: selectedGift.price,
                        timestamp: Date.now()
                    });
                }

                toggleGiftBox(false);
            } catch(e) { console.error(e); }
        };

        function showBanner(data) {
            const b = document.getElementById('globalBanner');
            const bg = document.getElementById('bannerBg');
            if(data.value >= 800000) bg.src = banners.diamond;
            else if(data.value >= 200000) bg.src = banners.gold;
            else bg.src = banners.silver;

            document.getElementById('bSender').src = data.senderImg;
            document.getElementById('nSender').innerText = data.senderName;
            document.getElementById('bReceiver').src = data.receiverImg;
            document.getElementById('nReceiver').innerText = data.receiverName;
            document.getElementById('bGift').src = data.giftImg;

            b.classList.add('active');
            setTimeout(() => b.classList.remove('active'), 3000); // 3 Seconds
        }

        window.sendMsg = async () => {
            const val = document.getElementById('mInput').value.trim();
            if(!val) return;
            document.getElementById('mInput').value = '';
            const cid = [auth.currentUser.uid, currentFriend.uid].sort().join('_');
            await push(ref(rtdb, `chats/${cid}/messages`), {
                senderId: auth.currentUser.uid,
                text: val,
                type: 'text',
                timestamp: serverTimestamp()
            });
        };

        window.goBack = () => window.history.back();
        lucide.createIcons();
    </script>
</body>
</html>

