<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan Private - Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans Arabic', sans-serif; }
        body { background: #ffffff; color: #000000; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Global Banner Animation: Top-Right -> Top-Left (3s) */
        #globalBanner {
            position: fixed;
            top: 15px;
            right: -100%;
            z-index: 9999;
            pointer-events: none;
            display: flex;
            align-items: center;
        }
        #globalBanner.active {
            animation: slideAcross 3s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }
        @keyframes slideAcross {
            0% { right: -100%; opacity: 0; }
            10% { right: 20px; opacity: 1; }
            90% { right: 20px; opacity: 1; transform: translateX(0); }
            100% { right: 100%; opacity: 0; transform: translateX(-500px); }
        }

        /* Messaging Layout */
        .msg-me { align-self: flex-end; background: #000000; color: #ffffff; border-radius: 15px 15px 2px 15px; }
        .msg-them { align-self: flex-start; background: #f3f4f6; color: #000000; border-radius: 15px 15px 15px 2px; }
        
        /* Gift Alignment */
        .gift-me { align-self: flex-end; }
        .gift-them { align-self: flex-start; }

        .modal-view {
            position: fixed; inset: 0; background: #ffffff; z-index: 500;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-view.active { transform: translateY(0); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-black { background: #000000; color: #ffffff; transition: all 0.2s; }
        .btn-black:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body>

    <!-- Global Banner -->
    <div id="globalBanner">
        <div class="relative w-[320px] h-[80px] bg-black rounded-2xl border border-gray-800 shadow-2xl flex items-center px-4 overflow-hidden">
            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
            <img id="bSender" class="w-10 h-10 rounded-full border border-white/50 relative z-10">
            <div class="flex-1 flex justify-center relative z-10">
                <img id="bGift" class="w-14 h-14 object-contain animate-bounce">
            </div>
            <img id="bReceiver" class="w-10 h-10 rounded-full border border-white/50 relative z-10">
        </div>
    </div>

    <!-- Header & Search -->
    <header class="p-4 border-b bg-white flex flex-col gap-4">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-black tracking-tighter">AFNAN</h1>
            <div class="flex gap-2">
                <button class="p-2 bg-gray-100 rounded-full"><i data-lucide="bell" class="w-5 h-5"></i></button>
                <button class="p-2 bg-black text-white rounded-full" onclick="toggleSearch(true)"><i data-lucide="search" class="w-5 h-5"></i></button>
            </div>
        </div>
    </header>

    <!-- Search Modal -->
    <div id="searchBar" class="hidden p-4 bg-gray-50 border-b animate-in fade-in slide-in-from-top-2">
        <div class="flex gap-2">
            <input type="text" id="userSearchInput" placeholder="Ø§Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ø§Ù„: 123456)..." class="flex-1 px-4 py-2 rounded-xl border focus:ring-2 focus:ring-black outline-none text-sm">
            <button onclick="findUser()" class="btn-black px-6 py-2 rounded-xl text-sm font-bold">Ø¨Ø­Ø«</button>
        </div>
    </div>

    <!-- Friends/Chats List -->
    <main id="friendsList" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
        <!-- Load from users -> friends -->
    </main>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal-view flex flex-col">
        <header class="h-16 border-b flex items-center justify-between px-4">
            <div class="flex items-center gap-3">
                <button onclick="closeChat()"><i data-lucide="arrow-right"></i></button>
                <div class="flex items-center gap-2 cursor-pointer" onclick="openProfile(currentFriend.uid)">
                    <img id="cAvatar" src="" class="w-10 h-10 rounded-full bg-gray-100 border">
                    <div>
                        <div id="cName" class="font-bold text-sm">...</div>
                        <div class="flex items-center gap-1 text-[8px] text-gray-400 font-bold uppercase tracking-widest">
                            <i data-lucide="lock" class="w-3 h-3 text-green-500"></i> E2EE ENCRYPTED
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="openProfile(currentFriend.uid)"><i data-lucide="menu"></i></button>
        </header>

        <div id="chatBox" class="flex-1 overflow-y-auto p-4 flex flex-col gap-4 bg-white no-scrollbar"></div>

        <div class="p-4 border-t flex items-center gap-3 bg-white">
            <button onclick="openGiftPicker()" class="p-2 bg-gray-100 rounded-full"><i data-lucide="gift" class="w-6 h-6"></i></button>
            <input type="text" id="mInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù…Ø´ÙØ±Ø©..." class="flex-1 bg-gray-50 rounded-2xl px-4 py-3 text-sm focus:outline-none border-none">
            <button onclick="sendEncryptedMsg()" class="bg-black text-white p-3 rounded-2xl"><i data-lucide="send" class="w-5 h-5"></i></button>
        </div>
    </div>

    <!-- Profile View (As requested: Fixed issues) -->
    <div id="profileModal" class="modal-view overflow-y-auto no-scrollbar">
        <div class="p-4 flex items-center justify-between border-b">
            <button onclick="closeProfile()"><i data-lucide="chevron-down"></i></button>
            <span class="font-black text-sm">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
            <button id="blockBtn" class="text-red-500"><i data-lucide="slash"></i></button>
        </div>

        <div class="p-8 text-center">
            <div class="relative inline-block group">
                <img id="pAvatar" src="" class="w-32 h-32 rounded-full border-4 border-black shadow-2xl mx-auto object-cover transition-transform group-active:scale-95 cursor-pointer">
                <div id="pMagicBadge" class="absolute -bottom-2 -right-2 bg-purple-600 text-white text-[10px] px-2 py-1 rounded-full border-2 border-white font-black shadow-lg">Magic LV 0</div>
            </div>
            
            <h2 id="pName" class="text-2xl font-black mt-4">...</h2>
            <p id="pId" class="text-xs text-gray-400 font-bold mt-1 tracking-widest uppercase">ID: 000000</p>

            <div class="flex justify-center gap-4 mt-6">
                <div class="bg-gray-50 p-3 rounded-2xl w-24 border">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Ø§Ù„Ø«Ø±ÙˆØ©</p>
                    <p id="pWealthLv" class="text-lg font-black">1</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-2xl w-24 border">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Ø§Ù„Ø³Ø­Ø±</p>
                    <p id="pMagicLv" class="text-lg font-black">1</p>
                </div>
            </div>

            <div class="mt-8 flex gap-2">
                <button id="friendActionBtn" class="flex-1 btn-black py-4 rounded-2xl font-black text-sm shadow-xl">ØªØ­Ù…ÙŠÙ„...</button>
                <button onclick="openGiftPicker()" class="p-4 bg-gray-100 rounded-2xl"><i data-lucide="gift"></i></button>
            </div>

            <!-- Received Gifts Area -->
            <div class="mt-10 text-right">
                <h3 class="font-black text-lg mb-4 border-r-4 border-black pr-3">Ø®Ø²Ø§Ù†Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h3>
                <div id="pGiftsGrid" class="grid grid-cols-4 gap-3 bg-gray-50 p-4 rounded-3xl min-h-[120px] border border-dashed border-gray-300">
                    <!-- Real Sync from Firestore -->
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Store (B&W Design) -->
    <div id="giftPicker" class="fixed inset-0 z-[600] bg-black/80 backdrop-blur-sm hidden flex flex-col justify-end" onclick="closeGiftPicker()">
        <div class="bg-white rounded-t-[40px] p-6 max-h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="font-black text-xl">Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</h3>
                    <p class="text-xs text-gray-400">Ø±ØµÙŠØ¯Ùƒ: <span id="uBalance" class="text-black font-bold">0</span> ğŸ’°</p>
                </div>
                <button onclick="closeGiftPicker()" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <button class="flex-1 py-2 bg-black text-white rounded-full text-[10px] font-bold uppercase tracking-wider">Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø«Ø±ÙˆØ©</button>
                <button class="flex-1 py-2 bg-gray-100 rounded-full text-[10px] font-bold uppercase tracking-wider">Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø³Ø­Ø±</button>
            </div>

            <div id="giftGrid" class="grid grid-cols-4 gap-3 overflow-y-auto no-scrollbar pb-10">
                <!-- Gifts from Firestore -->
            </div>

            <button id="sendGiftBtn" onclick="executeGiftSend()" class="w-full py-4 bg-gray-200 text-gray-400 rounded-2xl font-black disabled:opacity-50">Ø§Ø®ØªØ± Ù‚Ø·Ø¹Ø© ÙÙ†ÙŠØ©</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, onSnapshot, query, where, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getDatabase, ref, push, onValue, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        let userMe = null;
        let currentFriend = null;
        let selectedGift = null;
        let chatUnsub = null;

        const CIPHER_KEY = "AFNAN_SECURE_777";

        // Simple E2EE Helper
        const encrypt = (t) => t.split('').map(c => String.fromCharCode(c.charCodeAt(0) ^ CIPHER_KEY.charCodeAt(0))).join('');
        const decrypt = (t) => encrypt(t);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Real-time user data sync
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userMe = { uid: user.uid, ...snap.data() };
                    document.getElementById('uBalance').innerText = userMe.balance.toLocaleString();
                    renderFriends();
                });

                // Global Banner Listener (RTDB for speed)
                onValue(ref(rtdb, 'live_banners'), (snap) => {
                    const data = snap.val();
                    if(!data) return;
                    const last = Object.values(data).pop();
                    if(Date.now() - last.ts < 5000) triggerBanner(last);
                });
            }
        });

        async function findUser() {
            const input = document.getElementById('userSearchInput').value.trim();
            if(!input) return;
            const q = query(collection(db, "users"), where("customId", "==", input));
            const snap = await getDocs(q);
            if(snap.empty) return alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            openProfile(snap.docs[0].id);
        }

        async function renderFriends() {
            const container = document.getElementById('friendsList');
            container.innerHTML = '';
            const friendsIds = userMe.friends || [];
            
            for(const fid of friendsIds) {
                const fSnap = await getDoc(doc(db, "users", fid));
                if(fSnap.exists()) {
                    const f = fSnap.data();
                    const d = document.createElement('div');
                    d.className = "flex items-center justify-between p-4 bg-white border rounded-3xl shadow-sm cursor-pointer active:scale-95 transition-all";
                    d.innerHTML = `
                        <div class="flex items-center gap-4" onclick="openChat('${fid}')">
                            <img src="${f.photoURL}" class="w-14 h-14 rounded-full border bg-gray-50">
                            <div>
                                <h4 class="font-black text-sm">${f.displayName}</h4>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">ID: ${f.customId}</p>
                            </div>
                        </div>
                        <button onclick="openProfile('${fid}')" class="p-2 text-gray-300"><i data-lucide="chevron-left"></i></button>
                    `;
                    container.appendChild(d);
                }
            }
            lucide.createIcons();
        }

        window.openChat = async (uid) => {
            const snap = await getDoc(doc(db, "users", uid));
            currentFriend = { uid, ...snap.data() };
            document.getElementById('cName').innerText = currentFriend.displayName;
            document.getElementById('cAvatar').src = currentFriend.photoURL;
            document.getElementById('chatModal').classList.add('active');

            const cid = [auth.currentUser.uid, uid].sort().join('_');
            if(chatUnsub) chatUnsub();
            chatUnsub = onValue(ref(rtdb, `chats/${cid}/messages`), (snap) => {
                const box = document.getElementById('chatBox');
                box.innerHTML = '';
                const msgs = snap.val();
                if(!msgs) return;
                Object.values(msgs).forEach(m => {
                    const isMe = m.senderId === auth.currentUser.uid;
                    const d = document.createElement('div');
                    if(m.type === 'gift') {
                        d.className = isMe ? 'gift-me' : 'gift-them';
                        d.innerHTML = `<div class="p-2 bg-gray-50 rounded-2xl border flex flex-col items-center">
                                          <img src="${m.img}" class="w-20 h-20 object-contain">
                                          <p class="text-[9px] font-black uppercase mt-1">${m.name}</p>
                                       </div>`;
                    } else {
                        d.className = isMe ? 'msg-me' : 'msg-them';
                        d.className += " p-3 max-w-[80%] text-sm font-medium";
                        d.innerText = decrypt(m.text);
                    }
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendEncryptedMsg = async () => {
            const val = document.getElementById('mInput').value.trim();
            if(!val) return;
            const cid = [auth.currentUser.uid, currentFriend.uid].sort().join('_');
            await push(ref(rtdb, `chats/${cid}/messages`), {
                senderId: auth.currentUser.uid,
                text: encrypt(val),
                type: 'text',
                ts: serverTimestamp()
            });
            document.getElementById('mInput').value = '';
        };

        window.openProfile = async (uid) => {
            const snap = await getDoc(doc(db, "users", uid));
            const p = { uid, ...snap.data() };
            document.getElementById('pName').innerText = p.displayName;
            document.getElementById('pAvatar').src = p.photoURL;
            document.getElementById('pId').innerText = `ID: ${p.customId}`;
            document.getElementById('pWealthLv').innerText = p.wealthLevel || 1;
            document.getElementById('pMagicLv').innerText = p.magicLevel || 1;
            document.getElementById('pMagicBadge').innerText = `Magic LV ${p.magicLevel || 1}`;

            // Sync Received Gifts
            const grid = document.getElementById('pGiftsGrid');
            grid.innerHTML = '';
            if(p.receivedGifts) {
                Object.entries(p.receivedGifts).forEach(([gid, data]) => {
                    grid.innerHTML += `<div class="flex flex-col items-center bg-white p-2 rounded-2xl shadow-sm border">
                                          <img src="${data.image}" class="w-8 h-8 object-contain">
                                          <span class="text-[9px] font-black mt-1">x${data.count}</span>
                                       </div>`;
                });
            } else {
                grid.innerHTML = '<div class="col-span-4 text-center text-[10px] text-gray-300 py-10">Ø§Ù„Ø®Ø²Ø§Ù†Ø© ÙØ§Ø±ØºØ©</div>';
            }

            // Relationship Status / Action
            const btn = document.getElementById('friendActionBtn');
            if(userMe.friends?.includes(uid)) {
                btn.innerText = "ØµØ¯ÙŠÙ‚ (Ø¥Ø²Ø§Ù„Ø©)";
                btn.onclick = () => removeFriend(uid);
            } else if(userMe.sentRequests?.includes(uid)) {
                btn.innerText = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
                btn.disabled = true;
            } else {
                btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©";
                btn.disabled = false;
                btn.onclick = () => sendFriendRequest(uid);
            }

            currentFriend = p;
            document.getElementById('profileModal').classList.add('active');
            lucide.createIcons();
        };

        async function sendFriendRequest(uid) {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { sentRequests: arrayUnion(uid) });
            await updateDoc(doc(db, "users", uid), { friendRequests: arrayUnion(auth.currentUser.uid) });
            openProfile(uid);
        }

        async function removeFriend(uid) {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { friends: arrayRemove(uid) });
            await updateDoc(doc(db, "users", uid), { friends: arrayRemove(auth.currentUser.uid) });
            openProfile(uid);
        }

        window.openGiftPicker = async () => {
            document.getElementById('giftPicker').classList.remove('hidden');
            const grid = document.getElementById('giftGrid');
            grid.innerHTML = '<div class="col-span-4 py-10 text-center animate-pulse">...</div>';
            
            const q = query(collection(db, "gifts"));
            const snap = await getDocs(q);
            grid.innerHTML = '';
            snap.forEach(doc => {
                const g = { id: doc.id, ...doc.data() };
                const d = document.createElement('div');
                d.className = "flex flex-col items-center p-3 bg-gray-50 rounded-2xl border-2 border-transparent cursor-pointer transition-all active:scale-90";
                d.innerHTML = `<img src="${g.image}" class="w-10 h-10 object-contain">
                               <p class="text-[9px] font-black mt-2 uppercase text-center">${g.name}</p>
                               <p class="text-[8px] text-gray-400 font-bold">${g.price.toLocaleString()}</p>`;
                d.onclick = () => {
                    selectedGift = g;
                    document.querySelectorAll('#giftGrid > div').forEach(x => x.classList.remove('border-black', 'bg-white'));
                    d.classList.add('border-black', 'bg-white');
                    const btn = document.getElementById('sendGiftBtn');
                    btn.disabled = userMe.balance < g.price;
                    btn.innerText = userMe.balance < g.price ? "Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ" : `Ø¥Ø±Ø³Ø§Ù„ (${g.price.toLocaleString()})`;
                    btn.className = "w-full py-4 bg-black text-white rounded-2xl font-black";
                };
                grid.appendChild(d);
            });
        };

        window.executeGiftSend = async () => {
            if(!selectedGift || userMe.balance < selectedGift.price) return;
            const targetId = currentFriend.uid;
            
            try {
                // 1. Transaction
                await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-selectedGift.price) });
                
                // 2. Persistent Save to Target's receivedGifts
                const giftRef = `receivedGifts.${selectedGift.id}`;
                await updateDoc(doc(db, "users", targetId), {
                    [giftRef + ".count"]: increment(1),
                    [giftRef + ".image"]: selectedGift.image,
                    [giftRef + ".name"]: selectedGift.name,
                    wealthGiftsReceived: increment(1)
                });

                // 3. Send Signal to Chat (Real-time)
                const cid = [auth.currentUser.uid, targetId].sort().join('_');
                await push(ref(rtdb, `chats/${cid}/messages`), {
                    senderId: auth.currentUser.uid,
                    type: 'gift',
                    name: selectedGift.name,
                    img: selectedGift.image,
                    ts: serverTimestamp()
                });

                // 4. Global Banner
                await push(ref(rtdb, 'live_banners'), {
                    sImg: userMe.photoURL,
                    rImg: currentFriend.photoURL,
                    gImg: selectedGift.image,
                    ts: Date.now()
                });

                closeGiftPicker();
            } catch(e) { console.error(e); }
        };

        function triggerBanner(data) {
            const b = document.getElementById('globalBanner');
            document.getElementById('bSender').src = data.sImg;
            document.getElementById('bReceiver').src = data.rImg;
            document.getElementById('bGift').src = data.gImg;

            b.classList.remove('active');
            void b.offsetWidth; // force reflow
            b.classList.add('active');
        }

        window.toggleSearch = (show) => document.getElementById('searchBar').classList.toggle('hidden', !show);
        window.closeChat = () => document.getElementById('chatModal').classList.remove('active');
        window.closeProfile = () => document.getElementById('profileModal').classList.remove('active');
        window.closeGiftPicker = () => document.getElementById('giftPicker').classList.add('hidden');

        lucide.createIcons();
    </script>
</body>
</html>

