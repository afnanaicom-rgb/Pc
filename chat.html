<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø·ÙˆØ±</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans Arabic', sans-serif;
            touch-action: manipulation;
        }

        body {
            background: #f0f2f5;
            color: #1f2937;
            overflow: hidden; /* Prevent body scroll, handle in containers */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Chat Bubbles - Text Only */
        .chat-bubble-me {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border-radius: 20px 20px 4px 20px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
            position: relative;
        }

        .chat-bubble-them {
            background: white;
            color: #374151;
            border-radius: 20px 20px 20px 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* Gift Specific Styling - Floating directly on background */
        .gift-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            animation: floatUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .gift-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            /* No background bubbles */
        }

        .gift-image-anim {
            width: 140px;
            height: 140px;
            object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
            animation: pulseGift 2s infinite ease-in-out;
        }

        .gift-text {
            color: #4b5563;
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
            background: rgba(255,255,255,0.7);
            padding: 4px 12px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Gift Box Bottom Sheet */
        .gift-box-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .gift-box-overlay.active { opacity: 1; visibility: visible; }

        .gift-box-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 32px 32px 0 0;
            padding: 24px 20px 100px 20px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 60vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }

        .gift-box-overlay.active .gift-box-content { transform: translateY(0); }

        .gift-item {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .gift-item.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            transform: translateY(-2px);
        }

        /* Global Banner Animation */
        #globalBanner {
            transform: translateY(-150%);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #globalBanner.active {
            transform: translateY(0);
        }

        /* Profile Modal */
        #profileModal {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        #profileModal.active {
            transform: translateX(0);
        }

        /* Relationship Button Style */
        .relationship-btn {
            background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            border: 2px solid #ff758c;
            color: #c72d4b;
        }

        /* Keyframes */
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(20px) scale(0.8); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes pulseGift {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Status Indicator */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 0;
            right: 0;
        }
        .status-online { background-color: #22c55e; } /* Green */
        .status-offline { background-color: #9ca3af; } /* Gray */

    </style>
</head>
<body class="antialiased bg-slate-50">
    
    <!-- Global Banner -->
    <div id="globalBanner" class="fixed top-4 left-2 right-2 h-20 z-[60] rounded-2xl shadow-2xl flex items-center justify-between px-2 overflow-hidden pointer-events-none">
        <!-- Dynamic Background Image will be set here -->
        <img id="bannerBg" src="" class="absolute inset-0 w-full h-full object-cover z-0">
        
        <div class="relative z-10 flex items-center justify-between w-full px-2">
            <!-- Sender -->
            <div class="flex flex-col items-center">
                <img id="bannerSenderImg" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-md bg-white">
                <span id="bannerSenderName" class="text-[10px] font-bold text-white mt-1 drop-shadow-md truncate max-w-[60px]"></span>
            </div>

            <!-- Gift Info -->
            <div class="flex flex-col items-center mx-2 flex-1">
                <img id="bannerGiftImg" src="" class="w-12 h-12 object-contain drop-shadow-lg animate-bounce">
                <div class="bg-black/30 backdrop-blur-md px-2 py-0.5 rounded-full mt-1">
                    <span class="text-[10px] text-white font-bold">Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ© ÙØ§Ø®Ø±Ø©!</span>
                </div>
            </div>

            <!-- Receiver -->
            <div class="flex flex-col items-center">
                <img id="bannerReceiverImg" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-md bg-white">
                <span id="bannerReceiverName" class="text-[10px] font-bold text-white mt-1 drop-shadow-md truncate max-w-[60px]"></span>
            </div>
        </div>
    </div>

    <!-- Friend List Header -->
    <header class="fixed top-0 left-0 right-0 h-16 bg-white z-30 px-5 flex items-center justify-between shadow-sm">
        <button onclick="goBack()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100">
            <i data-lucide="chevron-right" class="w-6 h-6 text-gray-700"></i>
        </button>
        <h2 class="text-lg font-bold text-gray-800">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h2>
        <!-- Current User Avatar (Mini Profile) -->
        <div onclick="openProfile(auth.currentUser.uid)" class="w-10 h-10 relative cursor-pointer">
            <img id="myAvatar" src="https://via.placeholder.com/150" class="w-full h-full rounded-full object-cover border border-gray-200">
            <!-- Frame would go here -->
        </div>
    </header>

    <!-- Main List Content -->
    <main class="pt-20 px-5 pb-6 flex-1 overflow-y-auto">
        <div class="relative mb-6">
            <input type="text" id="searchFriendsInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚..." 
                   class="w-full h-12 pr-12 pl-4 rounded-2xl bg-white border-none ring-1 ring-gray-200 focus:ring-2 focus:ring-blue-500 text-sm shadow-sm transition-all">
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                <i data-lucide="search" class="w-5 h-5"></i>
            </div>
        </div>

        <div id="friendsList" class="space-y-3 pb-20"></div>

        <div id="noFriendsMessage" class="hidden flex flex-col items-center justify-center py-20">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="users" class="w-10 h-10 text-gray-400"></i>
            </div>
            <h3 class="font-bold text-gray-900 mb-2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</h3>
        </div>
    </main>

    <!-- Chat Modal -->
    <div id="chatModal" class="fixed inset-0 z-40 hidden flex flex-col bg-[#f0f2f5]">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" 
             style="background-image: radial-gradient(#64748b 1px, transparent 1px); background-size: 20px 20px;"></div>

        <header class="h-16 glass px-4 flex items-center justify-between z-20 shadow-sm relative">
            <div class="flex items-center gap-3">
                <button onclick="closeChat()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100 transition">
                    <i data-lucide="chevron-right" class="w-6 h-6 text-gray-700"></i>
                </button>
                <div class="flex items-center gap-2.5 cursor-pointer" onclick="openProfile(currentFriend.uid)">
                    <div class="relative">
                        <img id="chatUserAvatar" src="" class="w-10 h-10 rounded-full object-cover border border-gray-200 bg-white">
                        <div id="chatUserStatus" class="status-dot status-offline"></div>
                    </div>
                    <div class="flex flex-col">
                        <h4 id="chatUserName" class="font-bold text-sm text-gray-900 leading-tight">...</h4>
                        <span id="chatUserStatusText" class="text-[10px] text-gray-500 font-medium">ØºÙŠØ± Ù…ØªØµÙ„</span>
                    </div>
                </div>
            </div>
            <!-- Settings or Menu could go here -->
            <div class="w-10"></div>
        </header>
        
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 no-scrollbar relative z-10 scroll-smooth">
            <!-- Messages will be injected here -->
        </div>
        
        <!-- Input Area -->
        <div class="p-4 relative z-20 bg-white border-t border-gray-100">
            <div class="bg-gray-100 rounded-[24px] p-2 flex items-center gap-2">
                <!-- Gift Icon INSIDE the input bar as requested -->
                <button onclick="toggleGiftBox(true)" class="w-10 h-10 rounded-full flex items-center justify-center transition hover:scale-105 active:scale-95 shrink-0">
                    <img src="https://i.postimg.cc/Y0MLWDL5/sv.webp" class="w-8 h-8 object-contain" alt="Gift">
                </button>

                <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." 
                       class="flex-1 bg-transparent border-none focus:ring-0 text-sm text-gray-800 placeholder-gray-400 px-2 h-10"
                       autocomplete="off"
                       onkeypress="handleKeyPress(event)">
                
                <button onclick="sendMessage()" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-md hover:bg-blue-700 transition active:scale-95 shrink-0">
                    <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Full Page Profile Modal -->
    <div id="profileModal" class="fixed inset-0 z-50 bg-white flex flex-col overflow-y-auto">
        <!-- Close Button -->
        <button onclick="closeProfile()" class="absolute top-4 left-4 z-20 w-10 h-10 bg-black/20 backdrop-blur-md rounded-full flex items-center justify-center text-white">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>

        <!-- Header Image & Avatar -->
        <div class="relative h-48 bg-gradient-to-r from-blue-500 to-indigo-600">
            <div class="absolute -bottom-12 right-1/2 transform translate-x-1/2">
                <div class="relative">
                    <img id="profileAvatar" src="" class="w-24 h-24 rounded-full border-4 border-white object-cover bg-gray-200">
                    <!-- Frame Container -->
                    <div id="profileFrame" class="absolute inset-[-10px] pointer-events-none">
                        <!-- Frame Image gets injected here if exists -->
                    </div>
                </div>
            </div>
        </div>

        <!-- User Info -->
        <div class="mt-14 px-6 text-center">
            <h2 id="profileName" class="text-xl font-bold text-gray-900">User Name</h2>
            <div class="flex items-center justify-center gap-2 mt-1">
                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-md">ID: <span id="profileId">123456</span></span>
                <span class="text-xs text-white bg-gradient-to-r from-yellow-400 to-orange-500 px-2 py-0.5 rounded-md font-bold">Lv. <span id="profileLevel">1</span></span>
            </div>
            
            <p id="profileBio" class="text-sm text-gray-600 mt-4 leading-relaxed">
                Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø£Ø³ØªØ®Ø¯Ù… ØªØ·Ø¨ÙŠÙ‚ Ø£ÙÙ†Ø§Ù† Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©.
            </p>

            <div class="grid grid-cols-3 gap-4 mt-6">
                <div class="bg-gray-50 p-3 rounded-xl">
                    <div class="text-lg font-bold text-gray-800" id="statFriends">0</div>
                    <div class="text-[10px] text-gray-400">ØµØ¯ÙŠÙ‚</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl">
                    <div class="text-lg font-bold text-gray-800" id="statSent">0</div>
                    <div class="text-[10px] text-gray-400">Ø£Ø±Ø³Ù„</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl">
                    <div class="text-lg font-bold text-gray-800" id="statReceived">0</div>
                    <div class="text-[10px] text-gray-400">Ø§Ø³ØªÙ„Ù…</div>
                </div>
            </div>
        </div>

        <!-- Received Gifts -->
        <div class="px-6 mt-8">
            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <i data-lucide="gift" class="w-5 h-5 text-blue-500"></i> Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©
            </h3>
            <div id="profileGiftsGrid" class="grid grid-cols-4 gap-3 bg-gray-50 p-4 rounded-2xl min-h-[100px]">
                <!-- Injected Gifts -->
            </div>
        </div>

        <!-- Relationship Section -->
        <div class="px-6 mt-8 mb-10">
            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <i data-lucide="heart" class="w-5 h-5 text-pink-500"></i> Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø·ÙÙŠØ©
            </h3>
            <button class="w-full relationship-btn py-4 rounded-2xl flex items-center justify-between px-6 opacity-80 cursor-not-allowed relative overflow-hidden">
                <div class="flex items-center gap-3 relative z-10">
                    <div class="w-10 h-10 bg-white/30 rounded-full flex items-center justify-center">
                        <i data-lucide="lock" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-white">Ø¹Ù„Ø§Ù‚Ø© Ø­Ù…ÙŠÙ…Ø©</div>
                        <div class="text-[10px] text-white/80">Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                    </div>
                </div>
                <i data-lucide="heart-handshake" class="w-12 h-12 text-white/20 absolute -left-2 -bottom-2 rotate-12"></i>
            </button>
        </div>
    </div>

    <!-- Gift Box Overlay -->
    <div id="giftBoxOverlay" class="gift-box-overlay" onclick="handleOverlayClick(event)">
        <div class="gift-box-content">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>

            <div class="flex justify-between items-end mb-6 px-1">
                <div>
                    <h3 class="font-bold text-xl text-gray-900">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</h3>
                    <p class="text-xs text-gray-500 mt-1">Ø±ØµÙŠØ¯Ùƒ: <span id="giftWalletBalance" class="font-bold text-black">0</span> ğŸ’°</p>
                </div>
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="switchGiftTab('wealth')" id="tab-wealth" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow-sm">Ù‡Ø¯Ø§ÙŠØ§</button>
                    <button onclick="switchGiftTab('magic')" id="tab-magic" class="px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500 transition-all">Ø­Ø¸</button>
                </div>
            </div>

            <div id="giftGrid" class="grid grid-cols-4 gap-3 overflow-y-auto no-scrollbar pb-4" style="min-height: 180px;">
                </div>

            <div class="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-50 rounded-b-none">
                <button id="sendGiftBtn" onclick="confirmSendGift()" disabled
                        class="w-full py-3.5 rounded-2xl bg-gray-200 text-gray-400 font-bold text-sm shadow-none transition-all flex items-center justify-center gap-2">
                    <span>Ø§Ø®ØªØ± Ù‡Ø¯ÙŠØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, push, onValue, serverTimestamp, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb",
            databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com/"
        };

        // INITIALIZATION
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // GLOBAL VARS
        let userData = {};
        let currentFriend = null;
        let chatUnsubscribe = null;
        let presenceUnsubscribe = null;
        let storeData = { gifts: [], luckGifts: [] };
        let selectedGift = null;
        
        // BANNER IMAGES (Backgrounds)
        const BANNER_IMGS = {
            silver: "https://i.postimg.cc/23fY6g1g/sm.webp",
            gold: "https://i.postimg.cc/QVrDtvF2/sn.webp",
            diamond: "https://i.postimg.cc/Z0hmRXWg/so.webp"
        };

        // --- AUTH & PRESENCE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Fetch User Data
                const userSnap = await getDoc(doc(db, "users", user.uid));
                if (userSnap.exists()) {
                    userData = userSnap.data();
                    document.getElementById('myAvatar').src = userData.photoURL || 'https://via.placeholder.com/150';
                    loadFriends();
                    loadGifts();
                    initGlobalBannerListener();
                    
                    // Setup Real Presence
                    const connectedRef = ref(rtdb, ".info/connected");
                    const myStatusRef = ref(rtdb, "status/" + user.uid);
                    
                    onValue(connectedRef, (snap) => {
                        if (snap.val() === true) {
                            onDisconnect(myStatusRef).set({ state: 'offline', lastChanged: serverTimestamp() })
                                .then(() => {
                                    set(myStatusRef, { state: 'online', lastChanged: serverTimestamp() });
                                });
                        }
                    });
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- FRIENDS & LIST ---
        async function loadFriends() {
            const list = document.getElementById('friendsList');
            const noFriends = document.getElementById('noFriendsMessage');
            
            if (!userData.friends || userData.friends.length === 0) {
                list.classList.add('hidden');
                noFriends.classList.remove('hidden');
                return;
            }
            
            list.classList.remove('hidden');
            noFriends.classList.add('hidden');
            list.innerHTML = '';
            
            for (const uid of userData.friends) {
                // Fetch basic friend info
                const snap = await getDoc(doc(db, "users", uid));
                if (snap.exists()) {
                    const friend = snap.data();
                    
                    // Create element
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-2xl flex items-center justify-between shadow-sm border border-gray-100 hover:bg-gray-50 transition active:scale-[0.98]";
                    el.innerHTML = `
                        <div class="flex items-center gap-3 flex-1" onclick="openChat('${friend.uid}')">
                            <div class="relative">
                                <img src="${friend.photoURL || 'https://via.placeholder.com/150'}" class="w-12 h-12 rounded-full object-cover bg-gray-100 border border-gray-200">
                                <div id="status-${friend.uid}" class="status-dot status-offline border-white"></div>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-900">${friend.displayName}</h4>
                                <p class="text-xs text-gray-400">@${friend.customId || 'user'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="openProfile('${friend.uid}')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:text-blue-600">
                                <i data-lucide="user" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(el);

                    // Listen for this friend's status
                    const friendStatusRef = ref(rtdb, 'status/' + friend.uid);
                    onValue(friendStatusRef, (statusSnap) => {
                        const val = statusSnap.val();
                        const statusDot = document.getElementById(`status-${friend.uid}`);
                        if(statusDot) {
                            if (val && val.state === 'online') {
                                statusDot.classList.remove('status-offline');
                                statusDot.classList.add('status-online');
                            } else {
                                statusDot.classList.remove('status-online');
                                statusDot.classList.add('status-offline');
                            }
                        }
                    });
                }
            }
            lucide.createIcons();
        }

        async function loadGifts() {
            try {
                // Only load if not loaded
                if (storeData.gifts.length === 0) {
                    const giftsSnap = await getDocs(collection(db, "gifts"));
                    storeData.gifts = giftsSnap.docs.map(d => ({id: d.id, ...d.data(), type: 'wealth'}));
                    const luckSnap = await getDocs(collection(db, "luckGifts"));
                    storeData.luckGifts = luckSnap.docs.map(d => ({id: d.id, ...d.data(), type: 'magic'}));
                }
            } catch (error) { console.error('Error loading gifts', error); }
        }

        // --- GLOBAL BANNER LOGIC ---
        function initGlobalBannerListener() {
            // Listen to last child added to 'globalBanners' node
            const bannersRef = ref(rtdb, 'globalBanners');
            onValue(bannersRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                // Get the latest banner key
                const keys = Object.keys(data);
                const latestKey = keys[keys.length - 1];
                const bannerData = data[latestKey];
                
                // Check if this banner is recent (within last 10 seconds) to avoid spam on load
                if (Date.now() - bannerData.timestamp < 10000) {
                    showGlobalBanner(bannerData);
                }
            });
        }

        function showGlobalBanner(data) {
            const banner = document.getElementById('globalBanner');
            const bg = document.getElementById('bannerBg');
            
            // Set Background based on price tiers
            if (data.value >= 500000) bg.src = BANNER_IMGS.diamond;
            else if (data.value >= 150000) bg.src = BANNER_IMGS.gold;
            else bg.src = BANNER_IMGS.silver;

            // Set Content
            document.getElementById('bannerSenderImg').src = data.senderImg;
            document.getElementById('bannerSenderName').innerText = data.senderName;
            document.getElementById('bannerGiftImg').src = data.giftImg;
            document.getElementById('bannerReceiverImg').src = data.receiverImg;
            document.getElementById('bannerReceiverName').innerText = data.receiverName;

            // Animate
            banner.classList.add('active');
            
            // Hide after 6 seconds
            setTimeout(() => {
                banner.classList.remove('active');
            }, 6000);
        }

        // --- CHAT LOGIC ---
        window.openChat = async (uid) => {
            const snap = await getDoc(doc(db, "users", uid));
            if (!snap.exists()) return;
            
            currentFriend = snap.data();
            
            // UI Update
            document.getElementById('chatUserName').innerText = currentFriend.displayName;
            document.getElementById('chatUserAvatar').src = currentFriend.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('chatModal').classList.remove('hidden');
            
            // Listen for specific friend presence in chat header
            if(presenceUnsubscribe) presenceUnsubscribe();
            const statusRef = ref(rtdb, 'status/' + uid);
            presenceUnsubscribe = onValue(statusRef, (s) => {
                const val = s.val();
                const statusDot = document.getElementById('chatUserStatus');
                const statusText = document.getElementById('chatUserStatusText');
                
                if (val && val.state === 'online') {
                    statusDot.className = "status-dot status-online";
                    statusText.innerText = "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
                    statusText.className = "text-[10px] text-green-600 font-medium";
                } else {
                    statusDot.className = "status-dot status-offline";
                    statusText.innerText = "ØºÙŠØ± Ù…ØªØµÙ„";
                    statusText.className = "text-[10px] text-gray-400 font-medium";
                }
            });

            // Chat Messages
            const chatId = [auth.currentUser.uid, uid].sort().join('_');
            const chatRef = ref(rtdb, `chats/${chatId}/messages`);
            
            if (chatUnsubscribe) chatUnsubscribe();
            
            chatUnsubscribe = onValue(chatRef, (snapshot) => {
                const messages = snapshot.val();
                renderMessages(messages);
            });
        };

        function renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            if (!messages) {
                container.innerHTML = `<div class="text-center mt-20 opacity-40"><p class="text-sm">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù† ğŸ‘‹</p></div>`;
                return;
            }

            // Create fragment for performance
            const fragment = document.createDocumentFragment();

            Object.values(messages).sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
                const isMe = msg.senderId === auth.currentUser.uid;
                const div = document.createElement('div');
                div.className = `w-full flex ${isMe ? 'justify-end' : 'justify-start'} mb-4`;

                if (msg.type === 'gift') {
                    // NEW GIFT STYLE: Floating directly on background, no bubble
                    div.className = "gift-container"; // Center it
                    div.innerHTML = `
                        <div class="gift-content">
                            <img src="${msg.giftImage}" class="gift-image-anim" alt="Gift">
                            <div class="gift-text">
                                ${isMe ? 'Ø£Ø±Ø³Ù„Øª' : 'Ø£Ø±Ø³Ù„'} ${msg.giftName}
                                <span class="text-yellow-500 block text-[9px]">(${parseInt(msg.giftValue).toLocaleString()})</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Regular Text
                    div.innerHTML = `
                        <div class="max-w-[75%] px-4 py-2.5 text-sm font-medium leading-relaxed ${isMe ? 'chat-bubble-me' : 'chat-bubble-them'}">
                            ${msg.text}
                            <div class="text-[9px] opacity-60 mt-1 text-right dir-ltr">${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    `;
                }
                fragment.appendChild(div);
            });
            
            container.appendChild(fragment);
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
        }

        window.sendMessage = async () => {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentFriend) return;
            
            input.value = '';
            input.focus();

            try {
                const chatId = [auth.currentUser.uid, currentFriend.uid].sort().join('_');
                await push(ref(rtdb, `chats/${chatId}/messages`), {
                    senderId: auth.currentUser.uid,
                    receiverId: currentFriend.uid,
                    text: text,
                    type: 'text',
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error(e); }
        };

        window.handleKeyPress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };

        window.closeChat = () => {
            document.getElementById('chatModal').classList.add('hidden');
            if (chatUnsubscribe) chatUnsubscribe();
            if (presenceUnsubscribe) presenceUnsubscribe();
            currentFriend = null;
        };

        // --- PROFILE LOGIC ---
        window.openProfile = async (uid) => {
            const modal = document.getElementById('profileModal');
            
            // 1. Fetch User Data
            const userRef = doc(db, "users", uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) return alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            const pData = userSnap.data();

            // 2. Populate UI
            document.getElementById('profileAvatar').src = pData.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('profileName').innerText = pData.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
            document.getElementById('profileId').innerText = pData.customId || pData.uid.substring(0, 6);
            document.getElementById('profileLevel').innerText = pData.level || 1; // Assuming you have level field
            document.getElementById('profileBio').innerText = pData.bio || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­.";
            
            // Frame Logic (Example)
            const frameContainer = document.getElementById('profileFrame');
            frameContainer.innerHTML = '';
            if (pData.activeFrame) {
                frameContainer.innerHTML = `<img src="${pData.activeFrame}" class="w-full h-full object-contain">`;
            }

            // Stats (Mock or Real)
            document.getElementById('statFriends').innerText = pData.friends ? pData.friends.length : 0;
            // For sent/received counts, you'd usually query a subcollection. 
            // Here we use placeholders or simple fields if you added them to user doc.
            document.getElementById('statSent').innerText = pData.giftsSentCount || 0;
            document.getElementById('statReceived').innerText = pData.giftsReceivedCount || 0;

            // 3. Load Received Gifts (Visual only for now based on logic)
            // Ideally query "users/{uid}/receivedGifts"
            const giftsGrid = document.getElementById('profileGiftsGrid');
            giftsGrid.innerHTML = '';
            
            // Mocking display: If user has 'receivedGifts' array in DB
            if (pData.receivedGiftsLog && pData.receivedGiftsLog.length > 0) {
                 pData.receivedGiftsLog.slice(0, 8).forEach(g => {
                     giftsGrid.innerHTML += `
                        <div class="flex flex-col items-center">
                            <img src="${g.image}" class="w-10 h-10 object-contain">
                            <span class="text-[8px] mt-1 text-gray-500">x${g.count || 1}</span>
                        </div>
                     `;
                 });
            } else {
                giftsGrid.innerHTML = `<div class="col-span-4 text-center text-xs text-gray-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‡Ø¯Ø§ÙŠØ§ Ù…Ø³ØªÙ„Ù…Ø© Ø¨Ø¹Ø¯</div>`;
            }

            modal.classList.add('active');
        };

        window.closeProfile = () => {
            document.getElementById('profileModal').classList.remove('active');
        };

        // --- GIFT LOGIC ---
        window.toggleGiftBox = (show) => {
            const overlay = document.getElementById('giftBoxOverlay');
            if (show) {
                if (!currentFriend) return alert('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµØ¯ÙŠÙ‚ Ù…Ø­Ø¯Ø¯');
                overlay.classList.add('active');
                switchGiftTab('wealth');
                document.getElementById('giftWalletBalance').innerText = userData.balance.toLocaleString();
            } else {
                overlay.classList.remove('active');
                setTimeout(() => {
                    selectedGift = null;
                    updateSendButton();
                }, 300);
            }
        };

        window.handleOverlayClick = (e) => {
            if (e.target.id === 'giftBoxOverlay') toggleGiftBox(false);
        };

        window.switchGiftTab = (type) => {
            const wealthTab = document.getElementById('tab-wealth');
            const magicTab = document.getElementById('tab-magic');
            
            if (type === 'wealth') {
                wealthTab.className = "px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow-sm text-black border border-gray-100";
                magicTab.className = "px-4 py-1.5 rounded-lg text-xs font-bold text-gray-400 hover:text-gray-600";
            } else {
                wealthTab.className = "px-4 py-1.5 rounded-lg text-xs font-bold text-gray-400 hover:text-gray-600";
                magicTab.className = "px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow-sm text-black border border-gray-100";
            }

            const grid = document.getElementById('giftGrid');
            const gifts = type === 'wealth' ? storeData.gifts : storeData.luckGifts;
            
            grid.innerHTML = '';
            
            gifts.forEach(gift => {
                // Use dynamic pricing from Firebase object directly
                const price = gift.price || (type === 'wealth' ? 50000 : 20000); // Fallback if missing

                grid.innerHTML += `
                    <div onclick="selectGift('${gift.id}', '${type}', ${price}, '${gift.image}', '${gift.name}', this)" 
                         class="gift-item bg-gray-50 rounded-2xl p-2 flex flex-col items-center cursor-pointer hover:bg-gray-100 border border-transparent">
                        <img src="${gift.image}" class="w-12 h-12 object-contain mb-2 drop-shadow-sm">
                        <p class="text-[10px] font-bold text-gray-700 truncate w-full text-center">${gift.name}</p>
                        <p class="text-[9px] text-yellow-600 font-bold mt-0.5">${price.toLocaleString()}</p>
                    </div>
                `;
            });
        };

        window.selectGift = (id, type, price, image, name, elem) => {
            selectedGift = { id, type, price, image, name };
            document.querySelectorAll('.gift-item').forEach(el => el.classList.remove('selected'));
            elem.classList.add('selected');
            updateSendButton();
        };

        function updateSendButton() {
            const btn = document.getElementById('sendGiftBtn');
            if (selectedGift) {
                const canAfford = userData.balance >= selectedGift.price;
                btn.disabled = !canAfford;
                if(canAfford) {
                    btn.className = "w-full py-3.5 rounded-2xl bg-gradient-to-r from-gray-900 to-black text-white font-bold text-sm shadow-lg shadow-gray-900/20 transform transition active:scale-95 flex items-center justify-center gap-2";
                    btn.innerHTML = `<span>Ø¥Ø±Ø³Ø§Ù„ (${selectedGift.price.toLocaleString()})</span> <i data-lucide="send" class="w-4 h-4"></i>`;
                } else {
                    btn.className = "w-full py-3.5 rounded-2xl bg-red-50 text-red-400 font-bold text-sm flex items-center justify-center gap-2 cursor-not-allowed";
                    btn.innerHTML = `<span>Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ</span>`;
                }
            } else {
                btn.disabled = true;
                btn.className = "w-full py-3.5 rounded-2xl bg-gray-100 text-gray-400 font-bold text-sm shadow-none flex items-center justify-center gap-2";
                btn.innerHTML = `<span>Ø§Ø®ØªØ± Ù‡Ø¯ÙŠØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</span>`;
            }
            lucide.createIcons();
        }

        window.confirmSendGift = async () => {
            if (!selectedGift || !currentFriend) return;
            
            const btn = document.getElementById('sendGiftBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>';
            btn.disabled = true;
            
            try {
                // 1. Transaction: Deduct from Sender
                const userRef = doc(db, "users", auth.currentUser.uid);
                await updateDoc(userRef, { balance: increment(-selectedGift.price) });
                userData.balance -= selectedGift.price;

                // 2. Transaction: Add to Receiver
                // (Note: In a real app, use a batch or Cloud Function to ensure atomicity)
                const receiverRef = doc(db, "users", currentFriend.uid);
                await updateDoc(receiverRef, { 
                    balance: increment(selectedGift.price),
                    // Log the gift for profile display
                    // This is a simple append, for production use arrayUnion or subcollection
                    // receivedGiftsLog: arrayUnion({id: selectedGift.id, image: selectedGift.image, timestamp: Date.now()}) 
                });

                // 3. Send Chat Message
                const chatId = [auth.currentUser.uid, currentFriend.uid].sort().join('_');
                await push(ref(rtdb, `chats/${chatId}/messages`), {
                    senderId: auth.currentUser.uid,
                    receiverId: currentFriend.uid,
                    giftId: selectedGift.id,
                    giftName: selectedGift.name,
                    giftImage: selectedGift.image,
                    giftValue: selectedGift.price,
                    type: 'gift',
                    timestamp: serverTimestamp()
                });

                // 4. GLOBAL BANNER CHECK (> 80,000)
                if (selectedGift.price >= 80000) {
                    await push(ref(rtdb, 'globalBanners'), {
                        senderName: userData.displayName,
                        senderImg: userData.photoURL || 'https://via.placeholder.com/150',
                        receiverName: currentFriend.displayName,
                        receiverImg: currentFriend.photoURL || 'https://via.placeholder.com/150',
                        giftImg: selectedGift.image,
                        value: selectedGift.price,
                        timestamp: serverTimestamp()
                    });
                }

                toggleGiftBox(false);

            } catch (e) {
                console.error(e);
                alert('ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.goBack = () => window.location.href = 'afnan.html';
        
        lucide.createIcons();
    </script>
</body>
</html>

